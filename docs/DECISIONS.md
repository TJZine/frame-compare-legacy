# Decisions Log

- *2025-11-20:* fix(vspreview overlay): map JSON-tail suggestions into layout data and restore CLI hints (Phase 3).
  - Problem: `layout_data["vspreview"]` rendered `0f / 0.000s` suggested offsets even when audio alignment produced non-zero hints, leaving manual alignment prompts without guidance.
  - Decision: Treat `json_tail["suggested_frames"]`/`json_tail["suggested_seconds"]` as the source for layout hints, falling back to alignment summaries only when tail hints are missing; added a regression to ensure VSPreview layout surfaces non-zero suggestions from the tail.
  - Verification (2025-11-20 UTC):
    - `.venv/bin/pyright --warnings` (0 errors)
    - `.venv/bin/ruff check`
    - `.venv/bin/pytest -q` (445 passed, 1 skipped)

- *2025-11-20:* refactor(runner): retire legacy runner flag and path (Phase 1).
  - Problem: Legacy inline publishers still existed behind `runner.enable_service_mode` and CLI toggles, exposing an unsupported path and complicating the service-mode default.
  - Decision: Removed `_run_legacy_publishers` and made `_publish_results` service-only, emitting warnings when configs or overrides request legacy mode; removed CLI `--service-mode`/`--legacy-runner` options; deprecated `[runner].enable_service_mode` in the template while keeping the dataclass for compatibility; updated slow.pics/runner/CLI tests to assume service-mode baseline and refreshed README/refactor docs plus CHANGELOG.
  - Verification (2025-11-20 UTC):
    - `.venv/bin/pyright --warnings` (0 errors)
    - `.venv/bin/ruff check`
    - `.venv/bin/pytest -q` (444 passed, 1 skipped)

- *2025-11-19:* refactor(cli cleanup): finalize `frame_compare` CLI split with `cli_entry`/`cli_utils` wiring, keep `frame_compare.py` as thin shim, and align logs/docs.
  - Problem: Phase 4 required confirming no dead code remained after the CLI extraction and updating documentation/decision logs to match the final module boundaries without changing behavior.
  - Decision: Confirmed no unused imports or dead helpers in `frame_compare.py`, `src/frame_compare/cli_entry.py`, and `src/frame_compare/cli_utils.py`; validated `tests/helpers/runner_env.py` still patches the expected shim/runner symbols; refreshed the refactor checklist plus changelog to describe the stable shim/wiring layout.
  - Verification (2025-11-19 UTC):
    - `.venv/bin/pyright --warnings`
    - `.venv/bin/ruff check`
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` (444 passed, 1 skipped)
- *2025-11-19:* chore(cli+docs): gate `--tm-gamma-disable` on command-line sources and refresh Phase 2 snapshot.
  - Problem: `tm_gamma_disable` in `cli_entry.main` flowed straight into `_run_cli_entry`, so Click `default_map`/env values could disable post-gamma without an explicit flag. The Architecture Snapshot in `docs/refactor/frame_compare_cli_refactor.md` still claimed Click wiring lived in `frame_compare.py`, conflicting with the completed Phase 2 move.
  - Decision: Wrap `tm_gamma_disable` with `_cli_flag_value(..., default=False)` to preserve config-first tonemap semantics and updated the Architecture Snapshot to reflect `cli_entry` owning wiring with `frame_compare.py` as a delegating shim.
  - Verification: Not yet rerun (changes are wiring/doc only); rerun `.venv/bin/pyright --warnings`, `.venv/bin/ruff check`, `.venv/bin/pytest -q` next.
- *2025-11-19:* refactor(cli shim): move compatibility exports into `src/frame_compare/compat.py` so `frame_compare.py` stays a thin delegating surface (source:internal Phase 3 plan @ docs/refactor/frame_compare_cli_refactor.md).
  - Problem: `frame_compare.py` still hosted the `_COMPAT_EXPORTS` map and direct imports of CLI helper modules, making the shim carry CLI-specific baggage.
  - Decision: Added `src/frame_compare/compat.py` with `_COMPAT_EXPORTS` and `apply_compat_exports`, updated `frame_compare.py` to import the compat map, expose it for callers, and keep `main` delegating to `cli_entry.main` while leaving `run_cli` untouched.
  - Verification (2025-11-19 UTC):
    - `.venv/bin/pyright --warnings`
    - `.venv/bin/ruff check`
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` (444 passed, 1 skipped)

- *2025-11-19:* chore(docs+runner): correct `src/datatypes` references and normalize viewer metadata.
  - Problem: `docs/refactor/refactor_cleanup.md` instructed readers to touch a non-existent `src/datatype` module, and `src/frame_compare/runner.py` could leak `pathlib.Path` instances into `json_tail["viewer"]`/`layout_data["viewer"]` causing serialization churn. The `probe_clip_metadata` docstring also implied every clip gets reopened even though the cache avoids that path now.
  - Decision: Retargeted the refactor checklist to point at `src/datatypes.py`, coerced any report paths to strings before computing relative labels so both `destination` and `destination_label` stay JSON-safe, and refreshed the `probe_clip_metadata` docstring to mention cached snapshots plus the follow-up initialization performed by `init_clips`.
  - Verification:
    - `.venv/bin/pyright --warnings`
- *2025-11-19:* ci(decision-minute): harden workflow_run context access for Decision Minute generation (source:https://docs.github.com/en/actions/how-tos/write-workflows/choose-when-workflows-run/trigger-a-workflow@2025-11-19).
  - Problem: VS Code/GitHub Actions diagnostics flagged invalid context usage in `.github/workflows/decision-minute.yml` (`pull_requests[0]` without a guard and undeclared `steps.pr.outputs.*` fields), risking runtime errors when CI completed for non-merged PRs.
  - Decision: Kept the job gated to successful pull_request workflow_run events, fetched the full PR via `actions/github-script` before proceeding, short-circuited with a notice and empty output when the PR is not merged, and funneled all metadata through the action's `result` output (parsed with `fromJson`) so downstream steps are guarded on actual data rather than implicit outputs.
  - Verification: Not run (YAML/workflow-only change).
    - `.venv/bin/ruff check`
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q`
- *2025-11-19:* fix(net+slowpics+planner): enforce HTTPX timeouts, lock slow.pics progress, guard metadata mismatches.
  - Problem: `httpx_get_json_with_backoff` never forwarded timeout settings, so retries could hang indefinitely; slow.pics publishers performed `sum(file_sizes[:uploaded])` on each callback without any locking (O(n) work plus data races); and `planner.build_plans` still crashed with `IndexError` when metadata entries lagged behind discovered files.
  - Decision: Introduced `DEFAULT_HTTP_TIMEOUT` plus an explicit `timeout` parameter on `httpx_get_json_with_backoff`, plumbed it through TMDB `_http_request`/`_perform_search`/`_fetch_alias_titles`, and documented the default against HTTPX's timeout guidance (source:https://github.com/encode/httpx/blob/master/docs/advanced/timeouts.md@2025-11-19 via Context7). Added `UploadProgressTracker` (used by both the service-mode and legacy slow.pics publishers) so callbacks perform O(1) additions under a `threading.Lock`, refreshed `upload_comparison` docs to spell out the thread-safe contract, and extended `tests/runner/test_slowpics_workflow.py` with slice-guarding/perf and multi-threaded tracker tests. Finally, `planner.build_plans` now raises a `CLIAppError` listing the missing files instead of indexing past the metadata list, covered by a new regression test.
  - Implementation Notes:
    - Files touched: `src/frame_compare/net.py`, `src/tmdb.py`, `tests/net/test_httpx_backoff.py`, `tests/net/test_httpx_helpers.py`, `src/frame_compare/services/publishers.py`, `src/frame_compare/runner.py`, `src/frame_compare/slowpics.py`, `tests/runner/test_slowpics_workflow.py`, `src/frame_compare/planner.py`, `tests/test_planner.py`.
    - Follow-ups: none.
  - Verification:
    - `.venv/bin/pyright --warnings`
    - `.venv/bin/ruff check`
    - `.venv/bin/pytest tests/net -q`
    - `.venv/bin/pytest tests/runner/test_slowpics_workflow.py -k "progress or upload" -q`
    - `.venv/bin/pytest tests/test_planner.py -q`
- *2025-11-19:* fix(cli+cache): guard service-mode flags, metadata typing, and probe-cache parsing.
  - Problem: The CLI allowed users to pass `--service-mode` alongside `--legacy-runner` silently, RunContext assumed metadata dict values were `str`, and both the probe-cache loader and persistence path could still throw when cache keys or payload types drifted (plus `pick_analyze_file` indexed metadata without a bounds check).
  - Decision: Added explicit mutual exclusion for the two runner toggles plus a regression test, widened `RunContext.metadata` to `dict[str, Any]`, skipped metadata lookups when callers pass fewer entries than files, short-circuited cache persistence when a plan forgot to set `probe_cache_key`, and treated malformed JSON payloads as cache misses by wrapping `ClipProbeSnapshot` construction in a try/except.
  - Verification:
    - `.venv/bin/pyright --warnings`
    - `.venv/bin/ruff check`
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q`

- *2025-11-19:* chore(config): regenerate config defaults docs and make clip-metadata tests independent of VapourSynth.
  - Problem: CI lint failed because `docs/_generated/config_tables.md` lagged behind a new `RuntimeConfig.force_reprobe` option, and four tests in `tests/test_clip_metadata_probe.py` invoked the real `vs_core.set_ram_limit`, which tried to import VapourSynth and exploded on machines without the module.
  - Decision: Rebuilt the generated config tables via `tools/gen_config_docs.py` so the runtime defaults section now lists `force_reprobe`, and introduced an autouse `pytest` fixture that stubs `selection_module.vs_core.set_ram_limit` to a no-op while still allowing individual tests to override it when they need to capture calls.
  - Verification:
    - `.venv/bin/pytest tests/test_clip_metadata_probe.py -q`
    - `PYTHONPATH=$PWD/tmp_no_vs .venv/bin/pytest tests/test_clip_metadata_probe.py -q`

- *2025-11-19:* feat(runner): finish service-mode publisher wiring and CLI overrides.
  - Problem: The prior agent reverted the runner halfway through the publisher extraction, so `_publish_results`/`RunDependencies` were disconnected, CLI flags for `--service-mode`/`--legacy-runner` were undocumented, and pytest still patched `upload_comparison` even though the new services bypass that hook, causing real slow.pics uploads during tests.
  - Decision: Restored the service-mode plumbing inside `src/frame_compare/runner.py`, tightened `RunDependencies` defaults for `ReportPublisher`/`SlowpicsPublisher`, added CLI coverage in `tests/runner/test_cli_entry.py`, and taught all slow.pics workflow tests to opt into legacy mode via `service_mode_override=False` or `--legacy-runner` so they keep using the legacy stub helpers. Updated `tests/services/test_publishers.py` to exercise the service classes directly, refreshed README + docs/refactor/runner_service_split.md + CHANGELOG to describe the flag, and recorded the rollout plus verification details here and in docs/DECISIONS.md.
  - Verification:
    - `.venv/bin/pyright --warnings` (0 errors, 0 warnings)
    - `.venv/bin/ruff check` (All checks passed!)
    - `.venv/bin/pytest -q` (428 passed, 1 skipped)

- *2025-11-18:* refactor(services): extract MetadataResolver/AlignmentWorkflow for Track A (docs/refactor/runner_service_split.md).
  - Problem: `src/frame_compare/runner.py` still embedded TMDB lookup, plan construction, clip probing, and audio-alignment wiring, preventing unit tests and violating the service-boundary plan recorded in docs/refactor/runner_service_split.md.
  - Decision: Added `src/frame_compare/services/metadata.py`, `src/frame_compare/services/alignment.py`, and `src/frame_compare/services/factory.py` so the runner now issues typed `MetadataResolveRequest`/`AlignmentRequest` objects. MetadataResolver handles TMDB context, slow.pics title derivation, plan building, and clip probing through injectable adapters; AlignmentWorkflow wraps `alignment_runner.apply_audio_alignment`, `format_alignment_output`, and screenshot confirmation. Introduced service unit suites under `tests/services/` to verify TMDB happy-path/ambiguity/error flows and audio-alignment behaviors, and updated Track A Implementation Notes with the wiring/tests executed.
  - Verification:
    - `.venv/bin/pyright --warnings`
    - `.venv/bin/ruff check`
    - `.venv/bin/pytest -q`

- *2025-11-18:* feat(cache): define ClipProbeSnapshot contract, disk layout, and force-reprobe escape hatch.
  - Problem: Each run reopened VapourSynth clips twice and frequently dropped `_Matrix`/`MasteringDisplay*` props between probe/init, so HDR tonemapping would break whenever cached metadata drifted. We lacked a regression checklist that spelled out the metadata fields (fps, frame counts, geometry, props, trims, tonemap hints) that must survive probing.
  - Decision: catalogued the ClipPlan fields consumed by runners/tonemap/vspreview (effective/applied/source FPS, frame counts, width/height, trims, and the HDR prop set) and codified them inside a typed `ClipProbeSnapshot`. On every probe we now clone the prop dict before any trims padded, persist the full payload (including schema version + metadata digest) to `cache_dir/probe/<cache_key>.json`, and log tonemap-critical keys so regressions are obvious. `init_clips` reuses the live clip handles recorded on the snapshot, falls back to disk snapshots when bootstrapping a fresh process, and only reinitialises VapourSynth when trims/FPS overrides or the cache hash change. Added `RuntimeConfig.force_reprobe` so users can bypass reuse while debugging and wired structured cache summaries (`opened vs. reused vs. disk hits`). VapourSynth’s frame-prop lifetime rule (source:https://github.com/vapoursynth/vapoursynth/blob/master/doc/api/vapoursynth4.h.rst@2025-11-18T19:42:57Z via Context7) is cited here as the regression checklist anchor: once captured, the pre-trim props must survive through tonemapping.
  - Verification:
    - `.venv/bin/pyright --warnings`
    - `.venv/bin/ruff check`
    - `.venv/bin/pytest -q`

- *2025-11-18:* chore(review): sign off Track B Phases 3–6 config + flag invariants.
  - Problem: The remaining domains in docs/refactor/flag_audit.md (Screenshots/Render through TMDB/Source/Runtime) still needed a review agent to confirm “config wins unless a CLI flag explicitly overrides” and to fill the Track B → B4 + Global Invariants sections before Phase 2 could close.
  - Decision: Compared each B3 checklist against the implemented behaviour in `frame_compare.py` and `src/frame_compare/runner.py` (writer selection, cache probes, audio-alignment JSON seeds, HTML report/slow.pics handling, path precedence, TMDB/runtime flags) plus the regression suites in `tests/runner/test_cli_entry.py`, `tests/runner/test_audio_alignment_cli.py`, and `tests/runner/test_dovi_flags.py`. Updated docs/refactor/flag_audit.md to capture per-domain findings, checked all Global Invariant checkboxes, and noted that README.md + CHANGELOG.md already describe the precedence rules.
  - Verification:
    - `./.venv/bin/pyright --warnings`
    - `./.venv/bin/ruff check`
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 ./.venv/bin/pytest -q tests/runner/test_cli_entry.py tests/runner/test_audio_alignment_cli.py tests/runner/test_dovi_flags.py`

- *2025-11-18:* chore(audit): review Phase 1–2 config inventory and tonemap overrides.
  - Problem: Phase 1 (schema/load/CLI inventory) and Phase 2 (color/tonemap/DoVi) fixes needed verification that docs, code, and CLI behaviour now align and that “flag not passed” truly preserves config values.
  - Decision: Cross-checked the Track B inventory against `src/datatypes.py` and `src/frame_compare/preflight.py`, then validated `_cli_override_value()`/`_run_cli_entry()`/`runner.run()` so tonemap overrides only apply when Click reports `ParameterSource.COMMANDLINE`—per Click’s own guidance on `Context.get_parameter_source` (source:https://github.com/pallets/click/blob/main/docs/commands-and-groups.rst@2025-11-18T10:57:24Z via Context7). Recorded the review outcome in `docs/refactor/flag_audit.md` (A3/B4) and confirmed overlay/verify telemetry still mirrors config defaults in both entrypoints.
  - Verification:
    - `.venv/bin/pyright --warnings`
    - `.venv/bin/ruff check`
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/runner/test_dovi_flags.py`

- *2025-11-18:* fix(cli): extend default-map guards beyond tonemap and keep render metadata honest under debug fallbacks.
  - Problem: Even after the tonemap fixes, Click `default_map` values for path/cache/report/audio flags plus `--debug-color` still reached `_run_cli_entry()`, overriding config-driven behaviour and diverging `frame_compare.run_cli` from the Click CLI. Additionally, the JSON `render.writer` field stayed `ffmpeg` whenever `[screenshots].use_ffmpeg` was true, even though debug-color runs force VapourSynth rendering.
  - Decision: Introduced `_cli_flag_value()` so boolean options honour Click’s documented parameter-source semantics (source:https://github.com/pallets/click/blob/main/docs/commands-and-groups.rst@2025-11-18T12:10:00Z via Context7) and wired it up for `--root/--config/--input`, cache toggles, HTML-report flags, audio-track overrides, and `--debug-color`. Updated `runner.py` to derive the render writer from both `[screenshots].use_ffmpeg` and the effective debug flag so JSON tails reflect the actual renderer. Logged the audit + verification steps in `docs/refactor/flag_audit.md` (Track B → B2/B3) and `CHANGELOG.md`.
  - Verification:
    - `./.venv/bin/pyright --warnings`
    - `./.venv/bin/ruff check`
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 ./.venv/bin/pytest -q tests/runner`

- *2025-11-18:* fix(cli): ignore Click `default_map`/env-provided tonemap defaults unless the user passes a `--tm-*` flag.
  - Problem: `CliRunner` populates Click defaults via `default_map`/environment, so `frame_compare.main` kept treating inherited values as CLI overrides and overwrote `[color]` config even when the user never opted in.
  - Decision: Added `_cli_override_value()` so `_run_cli_entry()` only forwards tonemap overrides when `ctx.get_parameter_source(name)` reports `COMMANDLINE`, per the Click docs (source:https://github.com/pallets/click/blob/main/docs/commands-and-groups.rst@2025-11-18T08:28:30Z). Refreshed `tests/runner/test_dovi_flags.py` with new `CliRunner` width hints to keep Rich from wrapping JSON, plus coverage for `--tm-target`, default-map inheritance, and overlay/verify telemetry.
  - Verification:
    - `.venv\Scripts\pyright --warnings`
    - `.venv\Scripts\ruff check`
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv\Scripts\pytest -q tests/runner/test_dovi_flags.py`

- *2025-11-18:* fix(cli): align DoVi toggle semantics between Click CLI and runner.
  - Problem: `frame_compare.run_cli()` preserved `[color].use_dovi`, but invoking `frame_compare.main` without any `--tm-*` flags still injected `tonemap_overrides={"use_dovi": false, ...}`, so Dolby Vision metadata was silently disabled, yielding darker screenshots and contradictory JSON tails.
  - Decision: Use Click's parameter-source inspection to only treat tri-state toggles as overrides when `ParameterSource.COMMANDLINE` reports an explicit flag (per the official guidance on `Context.get_parameter_source`, source:https://github.com/pallets/click/blob/main/docs/commands-and-groups.rst@2025-11-18T07:15:29Z). Added a `_normalize_tm_toggle()` helper to coalesce implicit defaults back to `None`, plus regression tests that pin default inheritance and explicit `--tm-use-dovi`/`--tm-no-dovi` behavior via the CLI runner harness.
  - Verification:
    - `.venv\Scripts\pyright --warnings`
    - `.venv\Scripts\ruff check`
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv\Scripts\pytest -q tests/runner/test_dovi_flags.py`

- *2025-11-18:* chore(debug): gate FRAME_COMPARE_DOVI_DEBUG instrumentation across runner + VS core to trace tonemap parity.
  - Problem: Direct `frame_compare.run_cli()` calls and the Click CLI disagreed on `tonemap.use_dovi`, PNG contrast, and cache reuse hints, leaving no shared telemetry to compare config roots, overrides, or VapourSynth tonemap resolution phases.
  - Decision: Added a guarded `_emit_dovi_debug()` helper in the shared runner and VS tonemap module so setting `FRAME_COMPARE_DOVI_DEBUG` to a truthy value (`1`/`true`/`yes`/`on`) prints JSON diagnostics while explicit falsey strings (`0`/`false`/`no`/`off`) keep telemetry disabled (per Python's logging HOWTO guidance for structured logging, [source](https://github.com/python/cpython/blob/v3.11.14/Doc/howto/logging.rst) @ 2025-11-18T01:30:00Z). Runner logs cover config/root resolution, CLI overrides, cache status, render writer metadata, tonemap JSON assembly, and label derivation; VS core logs capture the incoming color config and the resolved VapourSynth payload for cross-checking entrypoints.
  - Verification:
    - `uv run pyright --warnings`

- *2025-11-16:* feat(tonemap): preserve preset semantics and document preset defaults.
  - Problem: Color presets never applied when configs stored template-aligned values because `_sanitize_section()` recorded every raw key as "provided", blocking `_resolve_tonemap_settings()` from sourcing preset defaults. Users also had no reference chart tying presets to actual luminance/smoothing targets, making manual tweaks guesswork.
  - Decision: Compare loader inputs against dataclass defaults (per CPython dataclass guidance, [source](https://github.com/python/cpython/blob/v3.11.14/Doc/library/dataclasses.rst) @ 2025-11-16T21:34:48Z) so `_provided_keys` only tracks genuine overrides, add regression tests spanning loader + VapourSynth tonemap resolution, annotate `_TONEMAP_PRESETS`, and mirror a preset matrix plus inline per-field comments in `src/data/config.toml.template`.
  - Verification:
    - `.venv/Scripts/pyright.exe --warnings`
    - `.venv/Scripts/ruff.exe check`
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/Scripts/pytest.exe -q tests/test_config_loader.py tests/test_vs_core.py tests/runner/test_cli_entry.py tests/test_screenshot.py`

- *2025-11-16:* fix(runner): normalize auto-letterbox telemetry, cached FPS fallbacks, and metadata tests.
  - Problem: `docs/DECISIONS.md` still used bare `source:` notes, operators could not see accepted `auto_letterbox_crop` values without trawling history, the runner serialized enum representations into JSON when configs used `AutoLetterboxCropMode`, and `_plan_fps_map()` prioritized `source_fps` before `applied_fps`/`fps_override` so cached hints diverged from `_estimate_frames_from_seconds()`. Missing FPS cache entries also logged only filenames, while the audio-alignment tests skipped asserting correlation strength, `_probe_fps()` avoidance, and metadata probe init parameters/frame-prop reuse.
  - Decision: Converted every `source:` string to Markdown links, documented the accepted letterbox inputs/case-insensitive parsing, and updated the runner to unwrap enum `.value` for JSON consistency (per the CPython Enum HOWTO’s `.value` guidance, [source](https://github.com/python/cpython/blob/v3.11.14/Doc/howto/enum.rst) @ 2025-11-16T03:14:39Z). `_plan_fps_map()` now mirrors the estimator precedence (effective → applied → source → override), rejects non-positive tuples, and the fallback log includes each plan’s label for quick identification. Tests assert the cached correlation (≈0.82), confirm `_probe_fps()` stays unused, lock the metadata `init_clip` calls, and ensure frame-prop dictionaries persist across re-probes.
  - Verification:
    - `.venv/bin/pyright --warnings`
    - `.venv/bin/ruff check`
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest tests/test_clip_metadata_probe.py tests/test_audio_alignment.py -q`

- *2025-11-15:* feat(screenshots): introduce explicit auto-letterbox modes and conservative heuristics.
  - Problem: the boolean `[screenshots].auto_letterbox_crop` toggle made it impossible to switch between the legacy (aggressive) ratio heuristic and a more conservative workflow, and it hid the effective mode from JSON telemetry. Debugging false-positive crops (like 3840×2160 masters vs. 3600×2160 trims) required reading logs to infer how the planner interpreted the setting.
  - Decision: Added an `AutoLetterboxCropMode` enum inspired by the standard library’s string-valued Enum guidance ([source](https://github.com/python/cpython/blob/v3.11.14/Doc/howto/enum.rst@2025-11-15T18:20:24Z)), changed `ScreenshotConfig.auto_letterbox_crop` to default to `"off"`, and normalised incoming config values so legacy booleans coerce to `"off"`/`"strict"`. `_plan_geometry` now resolves a mode upfront, exposes `_apply_letterbox_crop_strict` (legacy behaviour) and `_apply_letterbox_crop_basic` (post-aligned, conservative heuristic), and surfaces the resolved value in the runner’s JSON tail. Docs, the config template, and tables describe the new `off/basic/strict` modes, plus regression tests cover config coercion and both planner flows.
  - Verification:
    - `.venv/bin/pyright --warnings`
    - `.venv/bin/ruff check`
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q`

- *2025-11-15:* fix(alignment): refresh cached frame counts when trims shift mid-run.
  - Problem: Audio alignment and VSPreview manual offsets now tweak `ClipPlan.trim_start` before `selection.init_clips()` runs, but `probe_clip_metadata()` had already filled `source_num_frames`, so later initialisation skipped recomputing geometry. JSON summaries and screenshot overlays kept the original frame totals even when plans dropped or gained frames.
  - Decision: Whenever alignment/vspreview mutate `trim_start`, clear `plan.source_num_frames` so `selection.init_clips()` re-snapshots the trimmed clip. Regression coverage records each VapourSynth initialisation and asserts the CLI’s `clips` payload reflects the final trim applied to every file.
  - Verification:
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest tests/runner/test_audio_alignment_cli.py -k block_and_json -q`

- *2025-11-15:* fix(selection): pre-probe clip metadata for alignment and reuse HDR props snapshots.
  - Problem: `apply_audio_alignment()` frequently lacked FPS/geometry metadata so `_estimate_frames_from_seconds()` returned `None`, while repeated calls to `vs_core.init_clip()` kept re-snapshotting HDR frame props (and blank-padding negative trims with fresh, potentially mismatched metadata).
  - Decision: Added `probe_clip_metadata()` ahead of audio alignment so every `ClipPlan` has `effective_fps`, `applied_fps`, `source_fps`, `source_num_frames`, `source_width`, `source_height`, and `source_frame_props` populated before offsets are measured, and `selection.init_clips()` now reuses those cached values instead of clobbering them. `vs_core.init_clip()` accepts a `source_frame_props_hint` so `_extend_with_blank()` can reuse the previously captured HDR props when padding negative trims, aligning with VapourSynth's documented `getFrameProperties*` APIs for safe frame-prop reuse ([source](https://github.com/vapoursynth/vapoursynth/blob/master/doc/api/vapoursynth4.h.rst@2025-11-15T20:43:28Z)).
  - Verification:
    - `.venv/bin/pyright --warnings`
    - `.venv/bin/ruff check`
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q`

- *2025-11-15:* fix(audio): hydrate cached suggested offsets when reusing alignment files.
  - Problem: declining the recompute prompt reapplied cached trims but dropped any stored `suggested_frames`/`suggested_seconds`, so the CLI JSON tail and VSPreview overlay no longer showed the prior guidance (e.g., `+7f (~0.291s)`), defeating the cache reuse UX.
  - Decision: parse the cached `suggested_*` fields whenever `_maybe_reuse_cached_offsets()` or the reuse branch in `apply_audio_alignment()` iterate the offsets TOML, populate `summary.suggested_frames` plus `summary.measured_offsets` with those hints, and backstop the flow with a regression test that exercises the CLI formatter.
  - Evidence: `.venv/bin/pyright --warnings`, `.venv/bin/ruff check`, `.venv/bin/pytest -q tests/runner/test_audio_alignment_cli.py` (all passed)

- *2025-11-15:* fix(audio): derive VSPreview frame hints and keep negative manual trims.
  - Problem: Alignment summaries dropped negative `trim_start` overrides and emitted `0f` for suggested offsets whenever FPS metadata was missing, so the CLI/VSPreview overlay misreported `0f (~ -1.335s)` even when the measured seconds were non-zero.
  - Decision: Added a shared `derive_frame_hint()` helper that converts the raw measurements into frame counts (falling back to “n/a” when no FPS exists), plumbed it through `alignment_runner`, `runner`, `vspreview.render_script()`, and the prompt helpers, and removed the zero-clamping logic so negative manual trims persist through summaries, manual maps, and CLI JSON. New regression tests cover the negative-trim path and the `n/a` suggestion rendering.
  - Evidence: `.venv/bin/pyright --warnings`, `.venv/bin/ruff check`, `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/runner/test_audio_alignment_cli.py tests/test_vspreview.py` (all passed)
- *2025-11-15:* fix(audio): reuse cached FPS hints when measuring offsets.
  - Problem: When ffprobe omitted `r_frame_rate`, `measure_offsets()` surfaced only seconds while summary/vspreview suggestions fell back to `0f`, even though we already captured usable FPS metadata during the initial probe.
  - Decision: FFmpeg’s documentation notes that ffprobe surfaces stream metrics only when the container exposes them ([source](https://ffmpeg.org/ffmpeg-all.html/index@2025-11-15T23:42:24Z)), so we now build a per-plan FPS map (effective → source → applied → override), feed it into `audio_alignment.measure_offsets()`, and log whenever we must fall back to the seconds-based estimator so CLI/VSPreview immediately receive consistent frame deltas.
  - Evidence: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest tests/test_audio_alignment.py::test_measure_offsets_prefers_cached_fps_hints tests/test_alignment_runner.py::test_plan_fps_map_prioritizes_available_metadata -q`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest tests/runner/test_audio_alignment_cli.py -k block_and_json -q`
- *2025-11-15:* fix(tonemap): preserve HDR metadata for negative trims, honor CLI overrides under presets, and restore path-based color overrides.
  - Problem: Blank frames injected for negative trims lacked `_Transfer/_Primaries/_Matrix/_ColorRange` so HDR clips appeared SDR and skipped tonemapping; CLI tonemap overrides mutated config values but left `_provided_keys` untouched when presets were active, so libplacebo still read preset defaults; color overrides keyed by absolute/relative paths no longer matched because screenshot code now passed Path objects.
  - Decision: Snapshot the source props before padding and stamp those values onto the blank prefix so HDR detection continues to see the metadata, update CLI override handling to funnel conversions through a helper that also merges the overridden field names into `_provided_keys`, and coerce override lookup keys to `str(file_name)` before comparing so Path entries match again. Added regression tests covering HDR tonemap application with padding, CLI overrides overriding preset target_nits, and Path-based overrides.
  - Evidence: `.venv/bin/pyright --warnings`, `.venv/bin/ruff check`, `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/test_vs_core.py tests/test_screenshot.py tests/runner/test_cli_entry.py` (all passed)

- *2025-11-13:* chore(types): restored pyright strictness for `slowpics`, `analysis.cache_io`, and `cli_layout`.
  - Problem: `cli_layout.py` relied on `# pyright: standard` to hide Unknown-heavy template handling, and `slowpics.py` used loosely typed MultipartEncoder imports that failed strict mode whenever `requests-toolbelt` was optional, undermining the Part 1 typing guarantees for cache/selection code.
  - Decision: removed the downgrade, tightened MultipartEncoder typing with guarded imports and explicit Optional checks, validated every layout section/template/line/table entry before rendering, and exposed a renderer helper so progress columns no longer poke private attributes; cache modules already satisfied strict mode after the Part 1 snapshot refactor.
  - Evidence: `date -u +%Y-%m-%d` → `2025-11-13`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` (325 passed, 1 skipped); `.venv/bin/pyright --warnings` and `.venv/bin/ruff check` clean

- *2025-11-13:* fix(slowpics): shortcut creation is now best-effort with JSON telemetry for shortcut outcomes.
  - Problem: Uploads failed entirely when the `.url` shortcut could not be written, leaving users without the canonical slow.pics URL and no way to see why the shortcut was missing.
  - Decision: Wrap shortcut writes in `slowpics.upload_comparison()` with an OSError guard that warns but still returns the URL, and thread `shortcut_path`, `shortcut_written`, and `shortcut_error` through the runner/CLI JSON tail so reports/automation can describe failures. The CLI also emits a concise warning when it detects a missing shortcut.
  - Impact: slow.pics uploads always deliver their URL even on read-only volumes; telemetry differentiates disabled shortcuts from write failures (`disabled`, `invalid_shortcut_name`, `write_failed`), and docs explain the behavior so UI layers can reflect it.
  - Evidence: `date -u +%Y-%m-%d` → `2025-11-13`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/test_slowpics.py -k failure`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/runner/test_slowpics_workflow.py -k shortcut`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/test_slowpics.py` (all passed)
      .....................                                                    [100%]
      21 passed in 0.03s
      ```

- *2025-11-13:* dx(cache): cache recompute reasons are now surfaced in both CLI output and the JSON tail, and analysis logs include breadcrumbs for metrics/sidecar misses.
  - Problem: When frame metrics were rebuilt, operators only saw “Recomputing frame metrics…” without the underlying reason (config mismatch, fps mismatch, etc.), making it hard to tell why reuse failed. Selection sidecar misses also lacked observability.
  - Decision: Thread the probe reason into the progress message (`Recomputing frame metrics (<reason>)…`), emit a CLI line for missing caches, and log `[ANALYSIS] metrics cache miss: …` plus `[ANALYSIS] selection sidecar unavailable…` when applicable. JSON tail fields already carry `cache.reason`; now `analysis.cache_progress_message` mirrors the human-readable cause so UI and logs stay consistent.
  - Verification:
    - `date -u +%Y-%m-%d` → `2025-11-13`
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/runner/test_audio_alignment_cli.py::test_run_cli_surfaces_cache_recompute_reason tests/runner/test_audio_alignment_cli.py::test_run_cli_reports_missing_cache_reason` →
      ```
      ..                                                                       [100%]
      2 passed in 0.11s
      ```
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` →
      ```
      319 passed, 1 skipped in 28.08s
      ```
    - `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`
  - Context: This is a visibility-only change; reuse rules are unchanged. Sample reasons now shown to users: `config_mismatch`, `inputs_changed`, `fps_mismatch`, `trim_start_mismatch`, `trim_end_mismatch`, `release_group_mismatch`, `invalid_json`, `metric_type_error`, and `missing`.
  - Follow-up (log breadcrumbs now include file/cache identifiers):
    - `date -u +%Y-%m-%d` → `2025-11-13`
    - `git status -sb` →
      ```
      ## runner-refactor...origin/runner-refactor [ahead 3]
       M CHANGELOG.md
       M docs/DECISIONS.md
       M src/frame_compare/analysis/selection.py
       M src/frame_compare/runner.py
       M tests/runner/test_audio_alignment_cli.py
      ```
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/runner/test_audio_alignment_cli.py::test_run_cli_surfaces_cache_recompute_reason tests/runner/test_audio_alignment_cli.py::test_run_cli_reports_missing_cache_reason` →
      ```
      ..                                                                       [100%]
      2 passed in 0.04s
      ```
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` →
      ```
      319 passed, 1 skipped in 28.08s
      ```
    - `.venv/bin/ruff check` → `All checks passed!`
    - `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`

- *2025-11-13:* perf(cache): cache writes no longer re-hash clip payloads by default, and cache metadata can now carry precomputed clip inputs.
  - Problem: large media inputs forced `_build_clip_inputs` to read every byte when persisting selection caches, even though SHA1 digests are never consulted during reuse decisions (those keys rely on filenames, fps, config fingerprint, trims, and release group).
  - Decision: gate hashing behind `compute_sha1`/`FRAME_COMPARE_CACHE_HASH` (default off), keep the `"sha1"` field present but nullable, and extend `FrameMetricsCacheInfo` with an optional `clips` field populated by `cache.build_cache_info` so later cache builders can reuse the stat metadata without re-touching disk. Operators can export `FRAME_COMPARE_CACHE_HASH=1` when they explicitly want digests in the payload.
  - Alternatives considered: keep hashing enabled (too slow on multi-GB files) or defer clip precomputation to a later phase (implemented now so selection sidecars avoid redundant `stat()` calls the moment cache info is constructed).
  - Evidence: `date -u +%Y-%m-%d` → `2025-11-13`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/test_analysis.py -k "clip_inputs or selection_sidecar_cache_key_stable_without_sha1"`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/test_analysis.py::test_select_frames_uses_cache`; full suite clean (315 passed, 1 skipped); `.venv/bin/pyright --warnings`
  - Follow-up (compute_sha1 parameter coverage): `date -u +%Y-%m-%d` → `2025-11-13`; `git status -sb` captured ahead-of-branch state; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/test_analysis.py -k clip_inputs`; full suite clean (317 passed, 1 skipped); `.venv/bin/ruff check`; `.venv/bin/pyright --warnings`
  - Follow-up (require SHA1 when opted in, handle hashing failures safely): `date -u +%Y-%m-%d` → `2025-11-13`; `git status -sb` recorded touched files; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/test_analysis.py -k sha1`; `.venv/bin/ruff check`; `.venv/bin/pyright --warnings`
  - Context: SHA1 digests remain available for diagnostics, but cache reuse continues to hinge on deterministic input names/configuration so payload compatibility is unaffected by the nullable digest field.

- *2025-11-13:* Network policy hardening — centralized retry/timeout constants in `frame_compare/net.py`, added structured logging via `log_backoff_attempt`, threaded the callback through TMDB’s `_http_request`, and aligned slow.pics adapters/logs/tests with the shared policy while keeping the legacy upload endpoints. Redaction tests now cover userinfo/query edge cases, and slow.pics emits a final “upload complete” INFO that lists frames/workers.
  - Evidence: `date -u +%Y-%m-%d` → `2025-11-13`; `UV_CACHE_DIR=.uv_cache PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 uv run --no-sync python -m pytest -q tests/net tests/test_slowpics.py -k 'backoff or redact or adapter'`; `UV_CACHE_DIR=.uv_cache uv run --no-sync ruff check`; `UV_CACHE_DIR=.uv_cache uv run --no-sync npx pyright --warnings` (blocked offline; rerun with network access)
  - Reference: [source](https://github.com/urllib3/urllib3/blob/main/docs/user-guide.rst@2025-11-13T02:15:40Z) — documents urllib3’s default three retries/timeouts, reinforcing the centralized Retry policy applied here.

- *2025-11-13:* Release & packaging polish — enriched `pyproject.toml` metadata (description, license stanza, keywords, classifiers, URLs, authors), added `tools/check_wheel_contents.py` plus CI hooks on Linux/Windows, aligned `release-please` config with `project.name`/manifest paths, and introduced `.github/workflows/publish.yml` for a TestPyPI dry-run publish backed by OIDC. The packaging workflow now reuses the helper script and a new `windows-build` job catches platform-specific wheel regressions.
  - Evidence: `date -u +%Y-%m-%d` → `2025-11-13`; `UV_CACHE_DIR=.uv_cache uv run --no-sync python -m build` (offline failure fetching isolated `setuptools`); `UV_CACHE_DIR=.uv_cache uv run --no-sync twine check dist/*` (wheel + sdist passed)

- *2025-11-13:* Phase 11 cleanup follow-up — finalized the curated `frame_compare` export surface, synced `typings/frame_compare.pyi`, repointed the remaining tests/helpers/docs to `src.frame_compare.*`, and reiterated in the trackers that only the canonical modules (plus the curated exports) remain supported. Verified no shim imports remain, reran lint/type/test/import gates, and attempted the packaging build (still blocked offline) before checking the existing artifacts with Twine and a manual wheel audit.
  - `date -u +%Y-%m-%d` → `2025-11-13`
  - `git status -sb` →
    ```
    ## runner-refactor...origin/runner-refactor [ahead 6]
     M docs/config_audit.md
     M docs/refactor/mod_refactor.md
     M docs/runner_refactor_checklist.md
     M frame_compare.py
     M tests/helpers/runner_env.py
     M tests/runner/test_audio_alignment_cli.py
     M typings/frame_compare.pyi
    ```
  - `rg -n "from src\.(slowpics|cli_layout|report|config_template|vs_core)\b|import src\.(slowpics|cli_layout|report|config_template|vs_core)\b"` → *(no matches; exit status 1)*
  - `rg -n "\bfrom src import vs_core\b|\bsrc\.vs_core\b"` → *(no matches; exit status 1)*
  - `UV_CACHE_DIR=.uv_cache uv run --no-sync ruff check` → `All checks passed!`
- *2025-11-13:* Console-output sanitization — TMDB titles printed in prompts and verbose logs now pass through `sanitize_console_text` so escape/control sequences are stripped before the terminal sees them, while the raw metadata remains untouched for matching/persistence. The runner also sanitizes verbose slow.pics inputs, and the shared helper enforces OWASP A07 (Cross-Site Scripting – Output Encoding) guidance for console output. Follow-up: TMDB warning/notes (`tmdb_notes` + `collected_warnings`) now record console-safe text before `reporter.verbose_line`/`reporter.warn`, eliminating the last ANSI/control-character path.
  - `date -u +%Y-%m-%d` → `2025-11-13`
  - `git status -sb` →
    ```
    ## runner-refactor...origin/runner-refactor [ahead 1]
     M src/frame_compare/runner.py
    ```
  - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/test_tmdb.py -k prompt` →
    ```
    ..                                                                       [100%]
    2 passed, 10 deselected in 0.01s
    ```
  - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/test_layout_utils.py` →
    ```
    ...                                                                      [100%]
    3 passed in 0.01s
    ```
  - `.venv/bin/ruff check` → `All checks passed!`
  - `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`
  - Reference: [source](https://github.com/owasp/top10/blob/master/2017/he/0xa7-xss.md@2025-11-13T04:13:30Z) — demonstrates how unsanitized input can be injected directly into HTML attributes, illustrating the need for output encoding that `sanitize_console_text` now enforces on console-bound TMDB strings.
- *2025-11-13:* CI parity after renaming the default branch to `main` — `commitlint` now falls back to the repository’s root commit whenever GitHub reports the all-zero `before` SHA (first branch push), and `release-please` explicitly targets `main` so it no longer attempts to fetch manifests from a non-existent `legacy` branch.
  - `date -u +%Y-%m-%d` → `2025-11-13`
  - `git status -sb` →
    ```
    ## runner-refactor...origin/runner-refactor [ahead 1]
     M .github/workflows/commitlint.yml
     M .github/workflows/release-please.yml
     M CHANGELOG.md
     M docs/DECISIONS.md
     M src/frame_compare/analysis/cache_io.py
     M src/frame_compare/runner.py
     M tests/test_analysis.py
    ```
  - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/test_tmdb.py -k prompt` →
    ```
    ..                                                                       [100%]
    2 passed, 10 deselected in 0.01s
    ```
  - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/test_layout_utils.py` →
    ```
    ...                                                                      [100%]
    3 passed in 0.01s
    ```
  - `.venv/bin/ruff check` → `All checks passed!`
  - `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`
- *2025-11-13:* API hardening plan locked in `docs/refactor/api_hardening.md`: added `frame_compare.__all__` + stub alignment for the curated names (run_cli/main, RunRequest/RunResult, CLIAppError/ScreenshotError, TMDB + preflight + doctor helpers, collect_path_diagnostics, vs_core alias), created smoke tests under `tests/api/` and net helper coverage under `tests/net/`, refreshed `docs/README_REFERENCE.md`, and documented the policy in DEC/CHANGELOG`. Verification: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/api tests/net` → `11 passed in 0.02s`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `.venv/bin/ruff check` → `All checks passed!`; `UV_CACHE_DIR=.uv_cache uv run --no-sync lint-imports --config importlinter.ini` → `Contracts: 3 kept, 0 broken`.

- *2025-11-12:* Sub-phase 11.9 — CI & packaging checks. Extended the forbidden import-linter contracts so `src.frame_compare.render`, `src.frame_compare.analysis`, and `src.frame_compare.vs` cannot back-import the CLI shim or `src.frame_compare.core`, wired the lint workflow to run the config-doc generator `--check` step before enforcing `lint-imports`, and added a dedicated `packaging` GitHub job that builds artifacts, runs `twine check`, validates wheel contents, and surfaces warning-level notices from `check-wheel-contents`.
  - `date -u +%Y-%m-%d` → `2025-11-12`
  - `git status -sb` →
    ```
    ## runner-refactor...origin/runner-refactor [ahead 4]
     M .github/workflows/ci.yml
     M CHANGELOG.md
     M docs/DECISIONS.md
     M docs/refactor/mod_refactor.md
     M docs/runner_refactor_checklist.md
     M importlinter.ini
     M pyproject.toml
    ```
  - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `290 passed, 1 skipped in 40.69s` (after installing Homebrew `vapoursynth`, then running `UV_CACHE_DIR=.uv_cache uv pip install vapoursynth` to expose the Python bindings, followed by `UV_CACHE_DIR=.uv_cache uv pip install vspreview PySide6`).
  - `.venv/bin/ruff check` → `All checks passed!`
  - `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`
  - `python3 tools/gen_config_docs.py --check docs/_generated/config_tables.md` → exits `0` with no output
  - `UV_CACHE_DIR=.uv_cache uv run --no-sync lint-imports --config importlinter.ini` → `Contracts: 3 kept, 0 broken` (after `UV_CACHE_DIR=.uv_cache uv pip install import-linter`)
  - Packaging sweep (ran earlier in this session with network access): `uv run --no-sync python -m build` (produced sdist+wheel), `uv run --no-sync twine check dist/*` (clean aside from twine’s known description warning), inline wheel audit script (confirmed `src/frame_compare/py.typed` plus `data/config.toml.template`, `data/report/index.html`, `data/report/app.css`, `data/report/app.js`), and `uv run --no-sync check-wheel-contents dist/*.whl || true` (warnings only). Results recorded here so future sessions can rely on the verified artifacts.

- *2025-11-12:* CI adds a dedicated packaging job that runs `uv run --no-sync python -m build`, `uv run --no-sync twine check dist/*`, a wheel-contents validation script for `src/frame_compare/py.typed` plus `data/config.toml.template` and `data/report/{index.html,app.css,app.js}`, and `uv run --no-sync check-wheel-contents dist/*.whl || true` so the split modules keep shipping type/data assets correctly.

- *2025-11-12:* Import-linter’s `forbid_cli_backimports` and `forbid_core_backimports` contracts now list `src.frame_compare.render`, `src.frame_compare.analysis`, and `src.frame_compare.vs`, keeping the freshly split packages from depending on the CLI shim or `core`; verification stays `uv run --no-sync lint-imports --config importlinter.ini`.

- *2025-11-12:* The config-doc generator check from Sub-phase 11.8 now runs inside the lint workflow via `uv run --no-sync python tools/gen_config_docs.py --check docs/_generated/config_tables.md`, preventing drift between `src/datatypes.py` and the generated tables.

- *2025-11-12:* Sub-phase 11.8 — Config docs generation (stamped via `date -u +%Y-%m-%d`). Added `tools/gen_config_docs.py` to introspect the dataclasses in `src/datatypes.py`, generate `docs/_generated/config_tables.md`, and gate the `--check` mode so the verification bundle can detect drift without mutating the committed tables. The generated reference is linked from `docs/README_REFERENCE.md`, and the sentinel test `python3 tools/gen_config_docs.py --check docs/_generated/config_tables.md` now guards schema changes.
  - `date -u +%Y-%m-%d` → `2025-11-12`
  - `git status -sb` →
    ```
    ## runner-refactor...origin/runner-refactor [ahead 3]
     M CHANGELOG.md
     M docs/DECISIONS.md
     M docs/README_REFERENCE.md
     M docs/refactor/mod_refactor.md
     M docs/runner_refactor_checklist.md
     M importlinter.ini
     M src/frame_compare/slowpics.py
     M src/tmdb.py
    ?? docs/_generated/
    ?? src/frame_compare/net.py
    ?? tests/docs/
    ?? tools/
    ```
  - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `290 passed, 1 skipped in 40.15s`
  - `.venv/bin/ruff check` → `All checks passed!`
  - `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`
  - `python3 tools/gen_config_docs.py --check docs/_generated/config_tables.md` → exits `0` with no output
  - Residual risk: editing `src/datatypes.py` or related schema helpers still requires rerunning `tools/gen_config_docs.py` (without `--check`) before committing so `docs/_generated/config_tables.md` stays in sync; consider automating the regen once the script is trusted in CI.

- *2025-11-12:* Phase 11.7 — centralized network retries/backoff per `docs/refactor/mod_refactor.md`. Added `src/frame_compare/net.py` with `build_urllib3_retry`, `default_requests_timeouts`, `httpx_get_json_with_backoff`, and `redact_url_for_logs`, rewired slow.pics and TMDB to the shared policy, and listed `src.frame_compare.net` in the Runner→Core→Modules layer.
  - Slow.pics tests still patch `requests.Session`/`HTTPAdapter` (`tests/test_slowpics.py:166` and `tests/test_slowpics.py:216`), so `build_urllib3_retry` remains in `src/frame_compare/net.py:31`.
  - `redact_url_for_logs` lives in `src/frame_compare/net.py:100` for future sensitive endpoints, while slow.pics keeps `_redact_webhook` in `src/frame_compare/slowpics.py:53` to retain the `\"webhook\"` fallback token in its logging.
  - Verification commands shared with Sub-phase 11.8 (pytest/ruff/pyright) also ran clean locally.

- *2025-11-12:* Phase 11.10 — shim retirement. Deleted the remaining `src/{analysis,vs_core,slowpics,cli_layout,report,config_template}.py` bridges plus their `.pyi` stubs, repointed CLI/core/runtime/tests/docs to import from `src.frame_compare.*`, refreshed `frame_compare._COMPAT_EXPORTS`, and updated tracker docs (README reference, refactor log, DEC, CHANGELOG) with the new canonical imports.
  - `date -u +%Y-%m-%d` → `2025-11-12`
  - `git status -sb` →
    ```
    ## runner-refactor...origin/runner-refactor [ahead 5]
     M CHANGELOG.md
     M docs/DECISIONS.md
     M docs/README_REFERENCE.md
     M docs/config_audit.md
     M docs/current_pipeline_trace.md
     M docs/docs_inventory.md
     M docs/refactor/mod_refactor.md
     M docs/runner_refactor_checklist.md
     M frame_compare.py
     D src/analysis.py
     D src/cli_layout.py
     D src/cli_layout.pyi
     D src/config_template.py
     D src/config_template.pyi
     M src/frame_compare/alignment_preview.py
     M src/frame_compare/analysis/__init__.py
     M src/frame_compare/analysis/metrics.py
     M src/frame_compare/analysis/selection.py
     M src/frame_compare/cache.py
     M src/frame_compare/cli_runtime.py
     M src/frame_compare/core.py
     M src/frame_compare/preflight.py
     M src/frame_compare/render/overlay.py
     M src/frame_compare/runner.py
     M src/frame_compare/selection.py
     M src/frame_compare/vs/color.py
     M src/frame_compare/vs/source.py
     M src/frame_compare/vs/tonemap.py
     M src/frame_compare/vspreview.py
     D src/report.py
     D src/report.pyi
     M src/screenshot.py
     D src/slowpics.py
     D src/slowpics.pyi
     D src/vs_core.py
     D src/vs_core.pyi
     M tests/cli/test_layout.py
     M tests/helpers/runner_env.py
     M tests/render/test_overlay_text.py
     M tests/runner/test_audio_alignment_cli.py
     M tests/runner/test_cli_entry.py
     M tests/runner/test_slowpics_workflow.py
     M tests/test_analysis.py
     M tests/test_config.py
     M tests/test_config_template.py
     M tests/test_paths_preflight.py
     M tests/test_report.py
     M tests/test_screenshot.py
     M tests/test_slowpics.py
     M tests/test_vs_core.py
     M typings/frame_compare.pyi
    ```
  - `UV_CACHE_DIR=.uv_cache PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 uv run --no-sync python -m pytest -q` → `290 passed, 1 skipped in 40.03 s`
  - `UV_CACHE_DIR=.uv_cache uv run --no-sync ruff check --fix && UV_CACHE_DIR=.uv_cache uv run --no-sync ruff check` → clean
  - `UV_CACHE_DIR=.uv_cache uv run --no-sync npx pyright --warnings` (with sandbox escalation per policy) → clean
  - `UV_CACHE_DIR=.uv_cache uv run --no-sync lint-imports --config importlinter.ini` → `Contracts: 3 kept, 0 broken`
  - `UV_CACHE_DIR=.uv_cache uv run --no-sync python -m build` → **fails** (`pip` cannot download `wheel` in this sandbox: five retries, then “No matching distribution found for wheel”); `uv run --no-sync twine check dist/*` remains blocked until a cached artifact or mirror is available.
  - `rg -n "from src\.(slowpics|cli_layout|report|config_template|vs_core)\b|import src\.(slowpics|cli_layout|report|config_template|vs_core)\b"` → no matches; `rg -n "\bsrc\.(vs_core|slowpics|report|cli_layout|config_template)\b"` → no matches. Logged the packaging failure for follow-up once network access is restored or wheel dependencies are cached locally.
- *2025-11-13:* Packaging sweep + metadata polish. Added `readme = "README.md"` to `pyproject.toml`, rebuilt artifacts (`UV_CACHE_DIR=.uv_cache uv run --no-sync python -m build`), and re-ran `UV_CACHE_DIR=.uv_cache uv run --no-sync twine check dist/*`, which now passes without warnings. This closes the outstanding packaging action item from Phases 11.9/11.10.

- *2025-11-12:* Phase 11.6 — split `vs_core` by concern per `docs/refactor/mod_refactor.md`. Added the `src/frame_compare/vs/` subpackage (`env`, `source`, `props`, `color`, `tonemap`) with verbatim moves from `src/vs_core.py`, wired intra-package imports with `TYPE_CHECKING` guards, and replaced `src/vs_core.py` with a compatibility shim plus `.pyi` stub that proxies `_vs_module`, `_compute_luma_bounds`, `_detect_rgb_color_range`, `_apply_post_gamma_levels`, `_tonemap_with_retries`, etc., so existing monkeypatches keep working until Sub-phase 11.10 removes it. Updated `importlinter.ini` to include `src.frame_compare.vs` (and its modules) in the Runner→Core→Modules layer. After installing the `preview` extra locally, verification (2025-11-12): `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 2]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `289 passed, 1 skipped in 40.03 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `UV_CACHE_DIR=.uv_cache uv run --no-sync lint-imports --config importlinter.ini` → `Contracts: 3 kept, 0 broken`.
- *2025-11-12:* Phase 11.5 packaging cleanup — relocated `src/{cli_layout,report,slowpics,config_template}.py` (and their `.pyi` shims) into `src/frame_compare/`, updated the legacy modules to proxy the canonical module via `sys.modules[__name__] = _real_module` so monkeypatches hit the right globals, removed `Legacy/comp.py`, added `tests/__init__.py`, and appended the new modules to the Runner→Core→Modules layer in `importlinter.ini`. Added VSPreview extras locally (`uv pip install vspreview PySide6`) to satisfy the slow.pics tests. Verification (2025-11-12): `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 1]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `289 passed, 1 skipped in 39.96 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `UV_CACHE_DIR=.uv_cache uv run --no-sync lint-imports --config importlinter.ini` → `Contracts: 3 kept, 0 broken`. No external sources consulted.

# Decisions Log

- *2025-11-12:* Phase 11.4 logging normalization — replaced direct `print()`/`rich.print()` calls in `src/frame_compare/config_writer.py`, `src/frame_compare/core.py`, `src/frame_compare/runner.py`, `src/frame_compare/selection.py`, `src/frame_compare/tmdb_workflow.py`, and `src/screenshot.py` with module loggers, reporter console output, or Click echoes per the tracker scope; `selection.log_selection_windows` now accepts an optional reporter to preserve Rich formatting when present, and `tmdb_workflow` gained a `_style` helper to keep Click-based coloring without bringing Rich into the workflow module. Updated `docs/runner_refactor_checklist.md` best-practice anchors to clarify that only CLI presentation layers (and the generated VSPreview script) may call `print()`. Verification (2025-11-12): `git status -sb` → `## runner-refactor...origin/runner-refactor`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `289 passed, 1 skipped in 40.02 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `uv run --no-sync lint-imports --config importlinter.ini` initially failed with “Operation not permitted” while reading the shared UV cache, reran with `UV_CACHE_DIR=.uv_cache` → `Contracts: 3 kept, 0 broken`.
- *2025-11-12:* Phase 11.3 subprocess hardening landed. Added `src/frame_compare/subproc.py::run_checked` (argv-only, `shell=False`, stdio defaults, optional `check` raising `CalledProcessError`), refactored `src/screenshot.py`, `src/frame_compare/vspreview.py`, and `src/audio_alignment.py` to route FFmpeg/FFprobe/VSPreview invocations through the helper (preserving timeout handling and error messages), and updated the screenshot timeout/command-construction tests to monkeypatch `src.frame_compare.subproc.run_checked`. `importlinter.ini` now lists `src.frame_compare.subproc` in the Runner→Core→Modules contract, and documentation trackers are updated for Sub-phase 11.3. Verification (2025-11-12): `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `289 passed, 1 skipped in 39.98 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `UV_CACHE_DIR=.uv_cache uv run --no-sync lint-imports --config importlinter.ini` → `Contracts: 3 kept, 0 broken` (initial run without `UV_CACHE_DIR` failed with “Operation not permitted” while touching the shared cache). References: [source](https://github.com/python/cpython/blob/main/Doc/library/subprocess.rst@2025-11-12) (Context7, Markdown chunk “Handle subprocess.Popen TimeoutExpired Exception in Python”) — ensures `run_checked` propagates `TimeoutExpired` so callers can preserve the existing FFmpeg error mapping; [source](https://github.com/python/cpython/blob/main/Doc/library/subprocess.rst@2025-11-12) (Context7, Markdown chunk “Execute Shell Command with Error Checking in Python”) — confirms `check=True` should raise `CalledProcessError`, matching the helper’s optional `check` semantics.
- *2025-11-12:* Phase 11.2 split landed. Created `src/frame_compare/analysis/{__init__,cache_io,metrics,selection}.py`, moved the corresponding sections out of `src/analysis.py`, and left the old module as a thin shim that re-exports the legacy API (including the `_collect_metrics_*` helpers the tests patch). Selection now depends on the new modules via public aliases, and cache IO lazily imports the selection serializers under `TYPE_CHECKING` to keep cycles at bay. Added `# pyright: standard` headers in the three new modules so the rest of `src/frame_compare` can remain `strict` without forcing a rewrite of the legacy analysis types, and updated `importlinter.ini` to extend the Runner→Core→Modules contract with `src.frame_compare.analysis`. Verification (2025-11-12): `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `289 passed, 1 skipped in 40.06 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `UV_CACHE_DIR=.uv_cache uv run --no-sync lint-imports --config importlinter.ini` → `Contracts: 3 kept, 0 broken` (first attempt hit a permission error reading the default UV cache).
- *2025-11-12:* Phase 11.2 review — Verified the analysis package split on the documentation tracker/checklist, confirmed the shim still exposes the patched helpers, and re-ran the required quartet plus import-linter after the doc updates. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 30]` with only `docs/refactor/mod_refactor.md` and `docs/runner_refactor_checklist.md` staged; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `289 passed, 1 skipped in 39.98 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `UV_CACHE_DIR=.uv_cache uv run --no-sync lint-imports --config importlinter.ini` → `Contracts: 3 kept, 0 broken`.
- *2025-11-12:* Phase 11.3 review — Confirmed the subprocess hardening refactor (subproc helper + ffmpeg/ffprobe/vspreview call sites) matches the plan, updated trackers/checklist entries, and reran the verification suite after the documentation edits. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 31]` with only docs staged; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `289 passed, 1 skipped in 39.99 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `UV_CACHE_DIR=.uv_cache uv run --no-sync lint-imports --config importlinter.ini` → `Contracts: 3 kept, 0 broken`.
- *2025-11-12:* Phase 11.1 planning — Render helpers extraction. Planned `src/frame_compare/render/` package with `naming.py`, `geometry.py`, `overlay.py`, `encoders.py`; identified pure helpers to move from `src/screenshot.py` with wrappers to preserve behavior and test imports. Anchors recorded: naming (`src/screenshot.py:1957`, `:1965`, `:1971`, plus pattern at `:38`), overlay text/state (`:80`, `:133`, `:144`, `:194`, `:248`, `:266`, `:286`, `:308`, `:321`, styles at `:813`, `:817`), encoders (`:1975`, `:1983`, `:1988`, `:2345`, `:2351`), geometry helpers (`:154`, `:1135`, `:1146`, `:1377`, `:1398`, `:1440`, `:1479`, plus split/align at ~`:1556`, `:1568`, and scaled dims at ~`:1602`, describe axes at `:1157`). Kept `GeometryPlan` in `src/screenshot.py` for this sub‑phase. Verification gates set: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 pytest -q`, `.venv/bin/ruff check`, `.venv/bin/pyright --warnings`, and import‑linter after adding the new package to the modules layer. No external sources used; Serena MCP file/pattern search used to locate anchors.
- *2025-11-12:* Phase 11.2 planning — Analysis split (`metrics.py`, `selection.py`, `cache_io.py`). Planned new package `src/frame_compare/analysis/` and a shim in `src/analysis.py` (to be removed in 11.10). Anchors recorded (src/analysis.py): metrics `_quantile` (~371), `_frame_rate` (~1175), `_is_hdr_source` (~1258), `_collect_metrics_vapoursynth` (~1282), `_generate_metrics_fallback` (~1518), `_smooth_motion` (~1548); selection `SelectionWindowSpec` (~90), `SelectionDetail` (~131), `_frame_to_timecode` (~216), `_coerce_seconds` (~433), `compute_selection_window` (~457), `selection_details_to_json` (~354), `_serialize_selection_details` (~289), `_deserialize_selection_details` (~306), `_format_selection_annotation` (~341), `_selection_fingerprint` (~549), `selection_hash_for_config` (~579), `dedupe` (~1146), `select_frames` (~1571); cache IO dataclasses (`FrameMetricsCacheInfo` ~47, `CachedMetrics` ~62, `CacheLoadResult` ~81), `_threshold_snapshot` (~393), `_config_fingerprint` (~409), `_atomic_write_json` (~240), `_compute_file_sha1` (~268), sidecar functions (`_selection_sidecar_path` ~737, `_build_clip_inputs` ~755, `_selection_cache_key` ~784, `_selection_payload_from_inputs` ~800, `_build_selection_sidecar_payload` ~830, `_save_selection_sidecar` ~848, `write_selection_cache_file` ~927, `_load_selection_sidecar` ~985), cache probe (`probe_cached_metrics` ~585, loader ~720). Verification gates set: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 pytest -q`, `.venv/bin/ruff check`, `.venv/bin/pyright --warnings`, `uv run --no-sync lint-imports --config importlinter.ini` after appending `src.frame_compare.analysis` to the modules layer. No external sources used; anchors gathered via Serena search.
- *2025-11-12:* Phase 11.3 planning — Subprocess hardening. Planned `src/frame_compare/subproc.py` with `run_checked(argv, *, cwd=None, env=None, timeout=None, stdin=DEVNULL, stdout=PIPE, stderr=PIPE, text=True, check=False) -> CompletedProcess[str]` (always `shell=False`), and refactors in `src/screenshot.py` (ffmpeg writer), `src/frame_compare/vspreview.py` (launcher default runner), and `src/audio_alignment.py` (ffprobe/ffmpeg probing and extract) to use it. Anchors recorded: screenshot ffmpeg run block (~2375–2520); vspreview runner default (~959) and call site (~970); audio_alignment `probe_audio_streams` (~119–167), `_extract_audio` (~206–245), `_probe_fps` (~292–323). Tests to update: `tests/test_screenshot.py` monkeypatch targets switched from `screenshot.subprocess.run` to `src.frame_compare.subproc.run_checked` in timeout and filter‑chain tests. Verification gates: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 pytest -q`, `.venv/bin/ruff check`, `.venv/bin/pyright --warnings`, and import‑linter after adding `src.frame_compare.subproc` to the modules layer. No external sources used; anchors gathered via Serena search.
- *2025-11-12:* Phase 11.4 planning — Logging normalization. Normalize logging across library modules, replacing direct `print()`/`rich.print()` with module loggers or reporter calls, excluding the VSPreview generated script prints. Anchors recorded:
   - config_writer: `_present_diff` prints (~211–227).
   - runner: selection exception prints (~1255–1256) and slow.pics upload note (~1722).
   - core: analyze‑file selection note (~265).
   - selection: `from rich import print` (~8); prints at ~57, ~171–177, ~187, ~193–195; add optional reporter to `log_selection_windows`.
   - screenshot: overlay debug prints (~1848–1854, ~1877–1882, ~1932–1937) gated by `FRAME_COMPARE_LOG_OVERLAY_RANGE`.
   - tmdb_workflow: interactive guidance prints (~215–221, ~233, ~245–247, ~261) to migrate to `click.echo` or reporter.
   Exclusions: VSPreview script `safe_print` and `print()` lines in the persisted script (covered by `tests/test_console_safety.py`). Verification gates: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 pytest -q`, `.venv/bin/ruff check`, `.venv/bin/pyright --warnings`, `uv run --no-sync lint-imports --config importlinter.ini`. No external sources used; anchors gathered via Serena search.
- *2025-11-12:* Phase 11.5 planning — Packaging cleanup + legacy removal. Plan to relocate internal modules from `src/` to `src/frame_compare/` with thin shims left in place until 11.10; remove `Legacy/comp.py`. Moves: `src/cli_layout.py` → `src/frame_compare/cli_layout.py`, `src/report.py` → `src/frame_compare/report.py`, `src/slowpics.py` → `src/frame_compare/slowpics.py`, `src/config_template.py` → `src/frame_compare/config_template.py`. Shims at old paths re‑export `*` with `# type: ignore[F401,F403]`. Import‑linter layer to include `src.frame_compare.{cli_layout,report,slowpics,config_template}`. Exclusions for this sub‑phase: keep `src/datatypes.py`, `src/utils.py`, `src/tmdb.py`, `src/screenshot.py`, `src/vs_core.py`, and `src/analysis.py` shim. Anchors: file paths above and import sites in tests (for example, `tests/cli/test_layout.py` still referenced the legacy `src` package path for cli_layout/report/slowpics/config_template). Verification gates: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 pytest -q`, `.venv/bin/ruff check`, `.venv/bin/pyright --warnings`, and import‑linter after layer update. No external sources used; anchors gathered via Serena search.
- *2025-11-12:* Phase 11.6 planning — vs_core split by concerns. Plan to introduce `src/frame_compare/vs/{env,source,props,color,tonemap}.py` and a compatibility shim in `src/vs_core.py` that re-exports all used names (public and private helpers), to be removed in 11.10. Anchors recorded (src/vs_core.py): env/config (~21–28, ~229–360, ~326, ~1134), source/open/trim (plugin constants ~17–22; error classes ~41–76; `_set_source_preference` ~300; `_resolve_core` ~366; `_slice_clip` ~1056; `_extend_with_blank` ~1070; `_apply_fps_map` ~1090; `init_clip` ~1104), props/color extraction (mappings/labels ~138–227; `_describe_code` ~229; `_props_signal_hdr` ~736; `_coerce_prop` ~750; `_first_present` ~768; `_normalise_resolved_code` ~774; `_resolve_color_metadata` ~778; `_infer_frame_height` ~812; `_extract_frame_props` ~1186; `_snapshot_frame_props` ~1196), color normalization (`_resolve_configured_color_defaults` ~834; `_adjust_color_range_from_signal` ~1208; `normalise_color_metadata` ~1228; plus `_resolve_color_overrides`/`_guess_default_colourspace`), tonemap/verification (`TonemapInfo` ~92; `VerificationResult` ~121; `ColorDebugArtifacts` ~137; `TonemapSettings` ~150; `_parse_unexpected_kwarg` ~1872; `_call_tonemap_function` ~1898; `_apply_post_gamma_levels` ~1926; `_compute_verification` ~1969; `process_clip_for_screenshot` ~2010; `ClipProcessError`). Verification gates: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 pytest -q`, `.venv/bin/ruff check`, `.venv/bin/pyright --warnings`, `uv run --no-sync lint-imports --config importlinter.ini`. No external sources used; anchors gathered via Serena search.
 - *2025-11-12:* Phase 11.7 planning — Retry/backoff consolidation. Plan to add `src/frame_compare/net.py` with `build_urllib3_retry`, `default_requests_timeouts`, `httpx_get_json_with_backoff`, and `redact_url_for_logs`. Refactor slow.pics to build `urllib3.Retry` via `net.build_urllib3_retry` while keeping `HTTPAdapter` construction/mounting inside `src/frame_compare/slowpics.py` (tests patch `slowpics.HTTPAdapter` today). Refactor TMDB `_http_request` to delegate to `net.httpx_get_json_with_backoff`, preserving cache and error messages. Add `src.frame_compare.net` to the import-linter modules layer. Anchors: slow.pics adapter creation/mount (~400+), TMDB `_http_request` (~860–910). Verification gates: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 pytest -q`, `.venv/bin/ruff check`, `.venv/bin/pyright --warnings`, `uv run --no-sync lint-imports --config importlinter.ini`. No external sources used; anchors gathered via Serena search.
- *2025-11-12:* Phase 11.1 render helpers extraction completion. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 28]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `289 passed, 1 skipped in 40.19 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `uv run --no-sync lint-imports --config importlinter.ini` → `Contracts: 3 kept, 0 broken` (initial `uv` call hit a cache permission error and was re-run with elevated access). Added `src/frame_compare/render/{__init__,errors,encoders,geometry,naming,overlay}.py`, moved the pure helpers from `src/screenshot.py` with thin private wrappers, and updated `importlinter.ini` to include the new package in the modules layer. Created focussed suites under `tests/render/test_{naming,overlay_text,encoders,geometry_helpers}.py`, refreshed `docs/refactor/mod_refactor.md` (Phase 11 tracker + 11.1 notes), and added the Phase 11.1 checklist section to `docs/runner_refactor_checklist.md` alongside this DEC entry so the tracker + quartet remain in sync.
- *2025-11-12:* Phase 10.2 TMDB shim removal. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 25]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 39.99 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `uv run --no-sync lint-imports --config importlinter.ini` → `Contracts: 3 kept, 0 broken`. Deleted the transitional TMDB forwarders from `src/frame_compare/core.py`, dropped the `_resolve_tmdb_blocking` compat export in `frame_compare._COMPAT_EXPORTS`, updated runner helpers/tests (`tests/helpers/runner_env.py`, `tests/runner/test_cli_entry.py`, `tests/runner/test_slowpics_workflow.py`) to patch `tmdb_workflow` directly, refreshed typings + docs (README, config audit, tracker logs), and recorded the checklists for Phase 10.2.
 - *2025-11-12:* Documentation audit kickoff for Serena MCP integration. Updated `agents.md` to prioritize Serena for evidence sweeps (symbol/pattern search, sequential-thinking, project memory) and clarified Advisor verify behavior. Updated `CODEX.md` to add Serena as primary orchestration for code awareness and symbol-safe operations, list Serena analysis calls and mode changes under always-allowed checks, add missing Test Guardrails, and expand the “Always-logged MCP calls” rule to include Serena. Adjusted planning fallback to prefer Serena think tools → Sequential Thinking MCP → bullet outline. Updated `.serena/project.yml` to add an initial prompt and ignore heavy media paths.
   Sources (Context7):
   - [source](https://github.com/delano/zed-mcp-server-serena/blob/main/QUICK_START.md@2025-11-12T07:25:23Z) — confirms Serena MCP tool surface (get_symbols_overview, find_symbol, etc.) and extension behavior.
   - [source](https://github.com/delano/zed-mcp-server-serena/blob/main/DEVELOPING.md@2025-11-12T07:25:23Z) — shows `serena start-mcp-server` usage and `serena-agent` installation.
   - [source](https://github.com/oraios/serena/blob/main/DOCKER.md@2025-11-12T07:25:23Z) — documents `serena-mcp-server` and `--context ide-assistant`, Docker/Compose usage.
 - *2025-11-12:* Enable Markdown LSP in Serena. Added `markdown` to `.serena/project.yml:languages` so Serena’s symbol/outline and diagnostics work on docs (`*.md`), improving doc edits and heading-aware navigation alongside code work.
- *2025-11-12:* Phase 10.1 TMDB workflow extraction. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 24]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 40.12 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. Added `src/frame_compare/tmdb_workflow.py` to host `TMDBLookupResult`, retry/backoff helpers, prompts, and collection rendering; rewired `runner.py`, curated exports (`frame_compare._COMPAT_EXPORTS`, typings), and the CLI tests to patch the new module, while `core.py` now exposes thin forwarders for one release plus prompt wrappers that delegate into `tmdb_workflow`. Reference: [source](https://github.com/python/cpython/blob/v3.11.14/Doc/library/dataclasses.rst@2025-11-12T20:06:00Z) (Context7 “Define a Dataclass in Python”) — confirmed the dataclass contract stayed intact as we moved `TMDBLookupResult`.
- *2025-11-12:* Phase 9.12 Runner API docs + examples. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 23]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 39.98 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. Added a standalone “Programmatic Runner API” section (RunRequest/RunResult example, CLIAppError handling, RunResult output access), a “Programmatic Doctor (dependency checks)” example, curated import/typing guidance, and quick recipes in `README.md`, plus the new “API Reference” section in `docs/README_REFERENCE.md`. Tracker row 9.12 and the Phase 9.12 session checklist now document the docs-only work—quartet outcomes remain green since no runtime code changed.
- *2025-11-11:* Phase 9.10 selection public `__all__` contract. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 22]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 39.91 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. Ensured `src/frame_compare/selection.py` declares `__all__ = ["init_clips", "resolve_selection_windows", "log_selection_windows"]` (typed as `Final`) so wildcard imports stay limited to the documented helpers, per Python’s guidance on constraining package exports. Tracker row flipped to ☑ in `docs/refactor/mod_refactor.md` and the Phase 9.10 session checklist was logged with the quartet outputs. Reference: [source](https://github.com/python/cpython/blob/v3.11.14/Doc/tutorial/modules.rst@2025-11-11T11:51:18Z) (Context7, “Packages” — defining `__all__` so `from package import *` only exposes expected names).
- *2025-11-11:* Phase 9.9 CLI test relocation. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 21]`; baseline `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 39.93 s`. Moved the remaining CLI suites into `tests/cli/` (`test_wizard.py`, `test_doctor.py`, `test_help.py`, `test_layout.py`) and added `tests/cli/__init__.py` so pytest treats the folder as a package—otherwise it attempted to import both `tests/cli/test_wizard.py` and `tests/test_wizard.py` as the same `test_wizard` module. Targeted confidence runs: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/cli/test_doctor.py` → `2 passed in 0.01 s`; `... test_wizard.py` → `7 passed in 0.04 s`; `... test_help.py` → `1 passed in 0.01 s`; `... test_layout.py` → `2 passed in 0.01 s`. Post-move `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` stayed at `273 passed, 1 skipped in 39.90 s`, `.venv/bin/ruff check` reported `All checks passed!`, and `.venv/bin/pyright --warnings` reported `0 errors, 0 warnings, 0 informations`. Tracker + Session Checklist updated in `docs/refactor/mod_refactor.md` along with a DECISIONS entry describing the relocation. Reference: [source](https://github.com/pytest-dev/pytest/blob/main/doc/en/example/pythoncollection.md@2025-11-11T06:30:05Z) (Context7, “Customizing pytest's Python test naming conventions”) — confirms pytest derives module names from file paths and that packaging directories (`__init__.py`) keeps modules uniquely qualified when duplicate basenames exist.
- *2025-11-11:* Phase 9.9 doc/CI audit. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 21]`; `rg -n "tests/test_cli_"` (plus `rg -n "test_cli"` across `.github/`) showed only documentation references after the file moves, so automation globs already point at the right directories. Updated `docs/config_audit.md`, `docs/runner_refactor_checklist.md`, `docs/refactor/mod_refactor.md`, and this log to cite `tests/cli/test_*.py` (with parenthetical notes for the pre-Phase 9.9 names) so future contributors don’t chase deleted files. No code or CI changes were required; the audit confirms all commands/tests now use the `tests/cli/` layout.
- *2025-11-11:* Phase 9.9 documentation audit + verification. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 21]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 40.00 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. Synced `docs/runner_refactor_checklist.md` and `docs/refactor/mod_refactor.md` with the new `tests/cli/` structure (Phase 9.9 checklist + narrative) so reviewers know the relocation is complete and the pytest package marker rationale is documented. No code changes were necessary; this entry captures the verification quartet after the doc updates.
- *2025-11-11:* Phase 9.8 documentation audit + verification. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 20]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 40.04 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. Reconciled the Phase 9 trackers so `docs/runner_refactor_checklist.md` and `docs/refactor/mod_refactor.md` both document the shim removals completed in Phase 9.8, added the missing checklist section, and noted that curated exports now point straight to the extracted modules. No code changes were required because the removals already lived on the branch; Phase 10 scope (TMDB + wizard shims) remains unchanged.
- *2025-11-11:* Phase 9.7 import contracts and CI enforcement. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 19]`; `uv run --no-sync lint-imports --config importlinter.ini` → `Contracts: 3 kept, 0 broken`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `.venv/bin/ruff check` → `All checks passed!`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 39.94 s`. Added `importlinter.ini` with the runner→core→modules layering contract plus forbidden module→CLI/core barriers (temporary ignore noted for the existing runner→core shim), taught the lint workflow job to install and run `lint-imports` (the package only exposes that entrypoint, so `python -m importlinter` isn’t available), and tweaked `pyproject.toml`/`tests/cli/test_doctor.py` (renamed from `tests/test_cli_doctor.py`) so Ruff classifies `frame_compare` as first-party and keeps the import order stable. Reference: [source](https://github.com/seddonym/import-linter/blob/master/docs/contract_types.rst@2025-11-11T05:27:30Z) (Context7, “Layers Contract Configuration Reference” + “Forbidden Modules Contract Configuration Reference”) — confirms layers are ordered from higher→lower modules without wildcards and that forbidden contracts support ignore lists for curated exceptions.
- *2025-11-11:* Phase 9.8 legacy-shim removal. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 20]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 39.96 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. Deleted the redundant doctor/config-writer/presets/metadata/selection forwarders from `src/frame_compare/core.py`, updated the TMDB workflow to call `metadata.first_non_empty`/`parse_year_hint` inline, and replaced the bespoke `collect_doctor_checks` wrapper in `frame_compare.py` with a direct alias to `doctor_module.collect_checks` so `_COMPAT_EXPORTS` exposes the real modules instead of the old shims. Tracker + Session Checklist updated in `docs/refactor/mod_refactor.md`. Reference: [source](https://github.com/python/cpython/blob/v3.11.14/Doc/tutorial/modules.rst@2025-11-11T10:40:44Z) (Context7, snippet “Import a Python module with an alias”) — reiterates that curated APIs should expose the actual module object so downstream callers don’t rely on redundant wrappers.
- *2025-11-11:* Phase 9.6 fixture cleanup plan + representative refactors. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 18]`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `.venv/bin/ruff check` → `All checks passed!`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 40.13 s`. Added `VSPreviewPatch`, `install_vspreview_presence`, and `install_which_map` under `tests/helpers/runner_env.py`, introduced the `vspreview_env`, `which_map`, and `cli_env` fixtures in `tests/conftest.py`, and refactored `tests/cli/test_doctor.py` (formerly `tests/test_cli_doctor.py`) plus `tests/runner/test_audio_alignment_cli.py` to consume them while keeping legacy `_patch_*` helpers for back-compat. Updated `docs/refactor/mod_refactor.md` with the Phase 9.6 checklist and the CLI test split plan (`tests/cli/test_wizard.py` + `tests/cli/test_doctor.py` in Phase 10). Reference: [source](https://github.com/pytest-dev/pytest/blob/main/doc/en/how-to/fixtures.md@2025-11-11T09:52:27Z) (Context7, excerpt on composing fixtures) — reinforces returning callables/objects from fixtures instead of calling them directly.

- *2025-11-11:* Phase 9.5 curated exports + typing surface. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 17]`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `.venv/bin/ruff check` → `All checks passed!`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 39.98 s`. Updated `frame_compare._COMPAT_EXPORTS` so VSPreview helpers, doctor module, presets, and config_writer are surfaced from their dedicated modules (doctor helpers also exposed as `collect_doctor_checks` / `emit_doctor_results` / `DoctorCheck`), refreshed `typings/frame_compare.pyi` accordingly, and added `src/frame_compare/py.typed` plus the MANIFEST include so type checkers recognize the package as typed. Reference: [source](https://github.com/python/peps/blob/main/peps/pep-0561.rst@2025-11-11T08:20:53Z) (Context7, snippet “Configuring package_data for py.typed marker - Python”) — documents the requirement to ship a `py.typed` marker via package data for PEP 561 compliance.

- *2025-11-11:* Phase 9.4 selection/init helper extraction. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 16]`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 39.89 s`. Added `src/frame_compare/selection.py` with local `_extract_clip_fps`, TYPE_CHECKING-only imports, and the migrated `init_clips`/`resolve_selection_windows`/`log_selection_windows` helpers; `runner.py` now imports `selection_utils` while `src.frame_compare.core` exposes shim forwarders for compatibility. Updated `docs/refactor/mod_refactor.md` (Phase 9.4 row + Session Checklist) and this log with the verification outputs. Reference: [source](https://github.com/python/cpython/blob/v3.11.14/Doc/library/typing.rst@2025-11-11T08:02:55Z) (Context7, Markdown chunk “Conditionally Import and Annotate with TYPE_CHECKING”) — reaffirms guarding heavy imports behind `TYPE_CHECKING` to avoid runtime cycles while keeping annotations intact.
- *2025-11-11:* Phase 9.5 curated exports + typing. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 17]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped, 39.90 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. `frame_compare._COMPAT_EXPORTS` now includes the dedicated doctor/config_writer/presets modules plus VSPreview helpers, `typings/frame_compare.pyi` exposes the doctor APIs, and `src/frame_compare/py.typed` (included via `MANIFEST.in`) marks the package as typed for PEP 561 consumers. No README/CHANGELOG changes were needed because the exported symbols remain backwards compatible; future work (Phase 9.6) will focus on fixture cleanup planning before we drop the remaining shims.

- *2025-11-11:* Phase 9.3 runner unhook (trivial callers). `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 16]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 40.01 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. Added `src/frame_compare/runtime_utils.py` (fps/time/summary helpers), moved the simple metadata helpers into `src/frame_compare.metadata`, switched `runner.py` to import VSPreview constants + `_abort_if_site_packages` from their dedicated modules, and updated `docs/refactor/mod_refactor.md` + this log to mark Phase 9.3 complete while keeping `core` shims for compatibility. No new README/CHANGELOG entries required because behavior stayed internal.

- *2025-11-11:* Phase 9.2 verification (post-review). `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 15]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped, 39.89 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. Confirmed `config_writer.py` / `presets.py` own the template + preset flows, `frame_compare.py` imports them directly, and `src.frame_compare.core` keeps shims until Phase 9.5’s curated-export cleanup.

- *2025-11-11:* Phase 9.2 config-writer/presets extraction: `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 14]`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `.venv/bin/ruff check` → `All checks passed!`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 39.95 s`. Added `src/frame_compare/config_writer.py` (read/load/render/write helpers) and `src/frame_compare/presets.py`, rewired `frame_compare.py` to import them directly, and kept `src.frame_compare.core` forwarders for `_read_template_text` et al. No external docs were required beyond existing module references.

- *2025-11-11:* Phase 9.1 doctor extraction verification. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 14]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped, 39.98 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. `src/frame_compare/doctor.py` now owns the dependency checks, `frame_compare.py` routes both the `doctor` command and wizard prompts through `doctor_module`, and `src/frame_compare/core` retains `_collect_doctor_checks` / `_emit_doctor_results` shims until Phase 9.5 finalizes the curated exports.

- *2025-11-11:* Phase 9.1 (doctor extraction) landed. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 13]` before commit prep; created `src/frame_compare/doctor.py` with `DoctorCheck`, `collect_checks`, and `emit_results`, rewired the doctor CLI + wizard dependency check to call the module, and left `src.frame_compare.core` shims delegating for compatibility (tests still patch `core.importlib.util`). Tracker docs updated (`docs/refactor/mod_refactor.md` Phase 9.1 row ☑, `docs/runner_refactor_checklist.md` Phase 9 section) plus `CHANGELOG.md` now records the module move. Verification (2025-11-11): `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `.venv/bin/ruff check` → `All checks passed!`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped, 39.96s`.
- *2025-11-11:* Phase 8 documentation & cleanup complete. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 13]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped, 39.92 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. README now explains the `tests/runner/*` split + shared fixtures, CHANGELOG captures the runner test restructure/VSPreview guardrails, `docs/runner_refactor_checklist.md` gained the Phase 8 row, and `docs/refactor/mod_refactor.md` marks Phase 8 as ☑ with references to this entry. No residual Ruff/Pyright debt remains.

- *2025-11-11:* Phase 8 completion. README (Contributing) now points contributors to the `tests/runner/` layout, shared fixtures in `tests/helpers/runner_env.py`, and the VSPreview guardrails; `CHANGELOG.md` captures the Phase 6–7 runner test split + fail-fast shim; `docs/runner_refactor_checklist.md` and `docs/refactor/mod_refactor.md` both gained Phase 8 sections noting the doc refresh, Ruff decision, and verification references. Verification after the edits (2025-11-11): `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 12]` with the updated docs; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped, 39.96 s`; `.venv/bin/ruff check` → `All checks passed`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. Residual risk: `tests/runner/test_audio_alignment_cli.py::test_audio_alignment_vspreview_constants_raise_when_missing` still reloads `tests.helpers.runner_env` to simulate disappearing VSPreview exports, so we reset the module immediately afterward to avoid leaking state into other tests—leave the guard in place until pytest offers a smoother import-hook.
- *2025-11-11:* Phase 8 prep & doc planning. Baseline commands (2025-11-11): `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 12]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped, 39.92 s`; `.venv/bin/ruff check` → `All checks passed`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. Ruff no longer flags the previously noted import-order/unused-import debt, so Phase 8 can focus on documentation unless new warnings surface. Doc reference for the upcoming README/handbook updates: pytest fixture composition keeps shared helpers reusable across modules when they’re requested via parameters instead of direct calls ([source](https://github.com/pytest-dev/pytest/blob/main/doc/en/how-to/fixtures.md@2025-11-11)); this underpins the shared `tests/helpers/runner_env.py` fixtures we’re now documenting.
- *2025-11-11:* Phase 7 VSPreview shim validation kickoff. Baseline commands (2025-11-11): `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 11]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `272 passed, 1 skipped, 39.88 s`; `.venv/bin/ruff check` → `All checks passed`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings`. Scope: tighten the VSPreview test shims so missing CLI exports raise immediately, add regression coverage in `tests/runner/test_audio_alignment_cli.py`, and document each verification pass in Phase 7 per Pyright’s `Final` guidance ([source](https://github.com/microsoft/pyright/blob/main/docs/typed-libraries.md@2025-11-11)).
- *2025-11-11:* Phase 7 shim enforcement complete. `tests/helpers/runner_env.py` now routes `_VSPREVIEW_WINDOWS_INSTALL`/`_VSPREVIEW_POSIX_INSTALL` through `_require_vspreview_constant`, which raises `RuntimeError` when `frame_compare` stops exporting the CLI shims (per Pyright’s `Final` constant guidance; [source](https://github.com/microsoft/pyright/blob/main/docs/typed-libraries.md@2025-11-11)). `tests/runner/test_audio_alignment_cli.py::test_audio_alignment_vspreview_constants_raise_when_missing` monkeypatches the exports away, reloads `tests.helpers.runner_env`, and asserts the import fails so pytest catches shim drift immediately. Verification (2025-11-11): `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 11]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped, 39.99 s`; `.venv/bin/ruff check` → `All checks passed`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. Residual risk: the reload-based regression test temporarily mutates `tests.helpers.runner_env`, so it restores the module immediately after to keep other suites stable.
- *2025-11-11:* VSPreview manual offset persistence fix. `src/frame_compare/vspreview.py` now records manual VSPreview adjustments as per-clip deltas when calling `audio_alignment.update_offsets_file`, and `_reuse_vspreview_manual_offsets_if_available` reconstructs absolute trims by adding the stored delta back to each clip’s baseline trim. This keeps the offsets TOML + CLI telemetry consistent with auto alignment so future runs don’t over-trim. Verification: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `272 passed, 1 skipped, 40.00 s`; `.venv/bin/ruff check` → `All checks passed`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings`. Residual risk: manual reuse still skips seconds metadata in JSON (`offsets_sec` remains empty) but the runner surfaces the applied trims via `manual_trim_starts`, so no behavioral regression was observed.
- *2025-11-11:* Phase 6.3 runner test polish kick-off. Baseline commands (2025-11-11): `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 8]` (existing staged docs/src work plus the new `tests/helpers/` + `tests/runner/` trees from earlier sub-phases); `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `272 passed, 1 skipped, 40.09 s`; `.venv/bin/ruff check` still fails on the repo-wide import-order/unused-import debt in `src/frame_compare/alignment_runner.py`, `src/frame_compare/cli_runtime.py`, `src/frame_compare/runner.py`, `src/screenshot.py`, and `tests/test_alignment_runner.py`; `.venv/bin/pyright --warnings` reports the known `_format_vspreview_manual_command`/`_VSPREVIEW_*` attribute errors inside `tests/runner/test_audio_alignment_cli.py` plus the Final reassignment errors in `typings/frame_compare.pyi`. Scope for this sub-phase: finish the shared `dummy_progress` fixture, add a typed VSPreview shim for the audio-alignment tests, consolidate helpers, and re-run the verification quartet once the runner suites no longer rely on per-file patches.
- *2025-11-11:* Phase 6.3 runner test polish complete. Added `install_dummy_progress` + `dummy_progress` fixture so every runner suite automatically stubs Rich `Progress`, and centralised the VSPreview shim (`_format_vspreview_manual_command`, `_VSPREVIEW_*` typed constants) in `tests/helpers/runner_env.py` per Pyright’s constant guidance ([source](https://github.com/microsoft/pyright/blob/main/docs/typed-libraries.md@2025-11-10)). `tests/runner/test_audio_alignment_cli.py` now imports the shim directly, slow.pics/TMDB suites stopped calling `_patch_*("Progress", DummyProgress)`, and the helper audit confirmed no additional inline utilities needed relocation. Final verification (2025-11-11): `git status -sb` → unchanged `## runner-refactor...origin/runner-refactor [ahead 8]` with the existing staged docs/src backlog plus the in-flight runner test edits; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `272 passed, 1 skipped, 40.20 s`; `.venv/bin/ruff check` still fails on the long-standing import-order/unused-import issues in `src/frame_compare/alignment_runner.py`, `src/frame_compare/cli_runtime.py`, `src/frame_compare/runner.py`, `src/screenshot.py`, and `tests/test_alignment_runner.py` only; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings`. Residual risks: Ruff debt in the alignment/runner modules remains untouched, and the alignment-runner typing backlog recorded earlier is still open but no longer blocks the relocated runner suites.
- *2025-11-11:* Phase 6.2 runner test split landed. Created `tests/runner/test_cli_entry.py`, `tests/runner/test_audio_alignment_cli.py`, and `tests/runner/test_slowpics_workflow.py`, leaving `tests/test_frame_compare.py` as a shim-only regression suite with a relocation map. Introduced shared fixtures in `tests/conftest.py` (`runner`, `runner_vs_core_stub`) and moved `_expect_mapping`, `_patch_load_config`, `_selection_details_to_json`, and `DummyProgress` into `tests/helpers/runner_env.py` so every runner-focused module consumes the same helpers. Baseline commands (2025-11-11): `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 8]` (existing staged docs/src work plus new `tests/helpers/` and `tests/runner/` folders); `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` (272 passed, 1 skipped, 40.43 s); `.venv/bin/ruff check` still fails on the long-standing import-order/unused-import warnings in `src/frame_compare/alignment_runner.py`, `src/frame_compare/cli_runtime.py`, `src/frame_compare/runner.py`, `src/screenshot.py`, and `tests/test_alignment_runner.py`; `.venv/bin/pyright --warnings` raised the known `_format_vspreview_manual_command`/`_VSPREVIEW_*` attribute errors in `tests/test_frame_compare.py` plus the Final reassignment errors in `typings/frame_compare.pyi`. Post-split verification: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` (272 passed, 1 skipped, 40.09 s); `.venv/bin/ruff check` continues to fail on the same pre-existing modules (no new runner warnings after the split/fixes); `.venv/bin/pyright --warnings` now reports the `_format_vspreview_manual_command`/`_VSPREVIEW_*` attribute and Final errors out of `tests/runner/test_audio_alignment_cli.py` and `typings/frame_compare.pyi` (the shim symbol gaps moved with the tests). Docs updated: `docs/refactor/mod_refactor.md` progress tracker (Phase 6.1 + 6.2 rows now ☑), `docs/runner_refactor_checklist.md` (Phase 6.2 subsection recording destinations/fixtures/residual risks), `docs/config_audit.md` + `docs/audio_alignment_pipeline.md` (all references now point at the new runner test modules instead of the monolith), and `docs/DECISIONS.md` (this entry). Residual risks: slow.pics progress patching still relies on `DummyProgress` via `_patch_core_helper` (flagged for Phase 6.3), and the repo-wide Ruff/Pyright blockers remain unchanged.

- *2025-11-11:* Phase 6.1 shared fixtures landed: created `tests/helpers/runner_env.py` with `_CliRunnerEnv`, `_patch_*`, `_make_config`, JSON/VSPreview stubs, plus `tests/conftest.py` fixtures (`cli_runner_env`, `recording_output_manager`, `json_tail_stub`). Updated `tests/test_frame_compare.py`, `tests/test_alignment_runner.py`, and `tests/test_vspreview.py` to import from the shared helpers so future splits avoid circular imports. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 8]` (docs + helper/test edits staged alongside unrelated pending files). Verification: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` (272 passed, 1 skipped, 40.00 s); `.venv/bin/ruff check` still fails on the pre-existing import-order/unused-import warnings in `src/frame_compare/alignment_runner.py`, `src/frame_compare/cli_runtime.py`, `src/frame_compare/runner.py`, `src/screenshot.py`, and `tests/test_alignment_runner.py`; `.venv/bin/pyright --warnings` continues to report the known `_format_vspreview_manual_command`/`_VSPREVIEW_*` attribute/Final errors in `tests/test_frame_compare.py` and `typings/frame_compare.pyi`. Residual risk: helper extraction is clean, but repo-level Ruff/Pyright gates remain blocked on the longstanding alignment/VSPREVIEW shim issues.

- *2025-11-10:* Phase 4.2 VSPreview polish landed: runner now calls `alignment_runner.apply_audio_alignment` directly, `_write_vspreview_script` splits rendering/writes, `_launch_vspreview` logs missing executables/`VAPOURSYNTH_PYTHONPATH` with injectable subprocess runners, and `_apply_vspreview_manual_offsets` keeps JSON-tail `offsets_sec`/`offsets_frames` in sync while warning on unknown clip names. Added `tests/test_alignment_runner.py` for script persistence, launcher injection, and manual-offset telemetry. Reference: librosa onset-detection guidance for trim heuristics ([source](https://librosa.org/doc/latest/onset) @2025-11-10 via Context7). Verification commands: `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 8]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` (270 passed, 1 skipped, 40.08 s); `.venv/bin/ruff check` (clean); `.venv/bin/pyright --warnings` (0 errors, 0 warnings). `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1` remains required to sidestep third-party plugins in this environment.
- *2025-11-10:* Phase 3.2 prep: `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 5]`; `pytest -q` (209 passed, 54 skipped, 39.80 s); `.venv/bin/ruff check` (All checks passed); `npx pyright --warnings` (failed: npm ENOTFOUND registry.npmjs.org); fallback `.venv/bin/pyright --warnings` (0 errors, 0 warnings). `date -u +%Y-%m-%d` captured as 2025-11-10 for this entry.
- *2025-11-10:* Phase 3.2 verification: `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 5]`; `pytest -q` (211 passed, 54 skipped, 39.75 s); `.venv/bin/ruff check` (All checks passed); `npx pyright --warnings` (failed: npm ENOTFOUND registry.npmjs.org); fallback `.venv/bin/pyright --warnings` (0 errors, 0 warnings). `date -u +%Y-%m-%d` re-run for the log (2025-11-10).
- *2025-11-10:* Phase 2.3 prep: `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 3]`; `pytest -q` (209 passed, 54 skipped, 39.71 s); `.venv/bin/ruff check` (clean); `npx pyright --warnings` (failed: npm ENOTFOUND registry.npmjs.org); fallback `.venv/bin/pyright --warnings` (0 errors, 0 warnings). `date -u +%Y-%m-%d` captured as 2025-11-10 for the log entry.
- *2025-11-10:* Phase 2.3 verification: post-doc pass `git status -sb` still reports `## runner-refactor...origin/runner-refactor [ahead 3]`; `pytest -q` (209 passed, 54 skipped, 39.69 s); `.venv/bin/ruff check` (All checks passed); `npx pyright --warnings` (failed: npm ENOTFOUND registry.npmjs.org); fallback `.venv/bin/pyright --warnings` (0 errors, 0 warnings). `date -u +%Y-%m-%d` re-run to confirm the same stamp (2025-11-10).
- *2025-11-10:* Phase 2.1 baseline: `git status -sb` reports `## runner-refactor...origin/runner-refactor [ahead 1]`; `pytest -q` (207 passed, 54 skipped, 39.84 s), `.venv/bin/ruff check` (pass), `npx pyright --warnings` (failed: npm ENOTFOUND registry.npmjs.org), fallback `.venv/bin/pyright --warnings` (0 errors, 0 warnings).
- *2025-11-10:* Phase 2.1 wizard module verification: post-extraction `git status -sb` still shows a clean feature branch; `pytest -q` (209 passed, 54 skipped, 39.77 s), `.venv/bin/ruff check` (pass after removing an unused import), `npx pyright --warnings` (failed: npm ENOTFOUND registry.npmjs.org), fallback `.venv/bin/pyright --warnings` (0 errors, 0 warnings).
- *2025-11-10:* Phase 3.1 verification: `git status -sb` → `runner-refactor...origin/runner-refactor [ahead 4]` with staged metadata/doc edits; `pytest -q` (209 passed, 54 skipped, 39.91 s); `.venv/bin/ruff check` (All checks passed!); `npx pyright --warnings` (failed: npm ENOTFOUND registry.npmjs.org); fallback `.venv/bin/pyright --warnings` (0 errors, 0 warnings). Captured after wiring `runner.py` + tests to the new metadata module.
- *2025-11-10:* Phase 3.1 prep: `git status -sb` → `runner-refactor...origin/runner-refactor [ahead 4]`; `pytest -q` (209 passed, 54 skipped, 39.72 s); `.venv/bin/ruff check` (All checks passed!); `npx pyright --warnings` (failed: npm ENOTFOUND registry.npmjs.org); fallback `.venv/bin/pyright --warnings` (0 errors, 0 warnings). Logged before extracting the metadata helpers per Phase 3.1 plan.
- *2025-11-10:* Phase 2.2 prep: `git status -sb` → `runner-refactor...origin/runner-refactor [ahead 2]`; `pytest -q` (209 passed, 54 skipped, 39.84 s); `.venv/bin/ruff check` (clean); `npx pyright --warnings` (failed: npm ENOTFOUND registry.npmjs.org); fallback `.venv/bin/pyright --warnings` (0 errors, 0 warnings). Logged outputs here ahead of loader/wizard wiring updates.
- *2025-11-10:* Phase 2.2 verification: post-implementation `pytest -q` (209 passed, 54 skipped, 39.84 s), `.venv/bin/ruff check` (clean after ruff auto-fix sorted imports), `npx pyright --warnings` (failed: npm ENOTFOUND registry.npmjs.org), fallback `.venv/bin/pyright --warnings` (0 errors, 0 warnings).
- *2025-11-10:* Phase 1.2 kickoff prep: `git status -sb` shows `runner-refactor...origin/runner-refactor` with local edits in CODEX.md/README.md/agents.md/docs/DECISIONS.md; baseline checks ran `pytest -q` (204 passed, 54 skipped, 39.98s), `.venv/bin/ruff check` (clean), `npx pyright --warnings` (failed: npm ENOTFOUND registry.npmjs.org), and fallback `.venv/bin/pyright --warnings` (0 errors, 0 warnings).
- *2025-11-10:* Phase 1.2 validation: post-implementation `git status -sb` lists additional edits under docs/refactor/mod_refactor.md, docs/runner_refactor_checklist.md, frame_compare.py, src/frame_compare/core.py, tests/test_paths_preflight.py, and the new tests/test_preflight.py; verification commands — `pytest -q` (207 passed, 54 skipped, 39.73 s), `.venv/bin/ruff check` (pass), `npx pyright --warnings` (failed: npm ENOTFOUND registry.npmjs.org), fallback `.venv/bin/pyright --warnings` (0 errors, 0 warnings) — all recorded here.
- *2025-11-10:* Documented the sequential-thinking context management policy: CODEX now spells out how to summarize `process_thought`/`generate_summary` output, archive older thoughts, and prefer the lightweight summary path; AGENTS Standard Flow reminds advisors to enforce the rule, and README links humans to the new section so they know why responses stay condensed.
- *2025-11-10:* Tuned the context-management defaults to keep roughly 7–10 recent Sequential Thinking entries (instead of 3–5) in active chat, clarifying that Codex may momentarily expand the window during complex branches while still using the MCP log for archives; README and AGENTS were updated accordingly.
- *2025-11-10:* Documented Sequential Thinking metadata etiquette: README now explains that `files_touched`, `tests_to_run`, `dependencies`, etc. stay empty when not used, CODEX forbids fabricated filenames/tests/risk levels, and AGENTS remind reviewers to flag hallucinated metadata.
- *2025-11-10:* Strengthened AGENTS/CODEX guardrails for MCP tooling: Standard Flow now mandates Context7-first citations and detailed Fetch MCP metadata logging (URL, timestamp, format, chunking) directly in responses, plus TaskFlow + snf-mcp recommendations for structured planning/search (no repo-level evidence storage yet per user request). CODEX now lists MCP usage in Execution & Approvals, adds an escalation playbook, clarifies `.venv`-first verification with `uv sync` fallbacks, and records how large refactors can proceed once a micro-plan + verification schedule are approved.
- *2025-11-10:* Corrected future-dated DECISIONS/CHANGELOG entries by aligning them with actual UTC (`date -u`) stamps and updated AGENTS/CODEX so every log requires capturing the current date before writing.
- *2025-11-08:* Started the configuration-audit initiative requested by the user: created `docs/config_audit.md` to track per-category findings/status, recorded the workflow expectations (Context7 reference, ripgrep sweeps, approval gates), and deferred all actual config/code updates until the user signs off category-by-category.
- *2025-11-08:* Landed the `[analysis]` configuration cleanup: removed the redundant `skip_head_seconds`/`skip_tail_seconds` knobs (loader now migrates them onto `ignore_*` with conflict checks), introduced `[analysis.thresholds]` with an explicit `mode = "quantile" | "fixed_range"` plus validated quantile/luma payloads, and updated the runner/JSON layouts so operators can see the active strategy.
- *2025-11-08:* Addressed the Phase 4 “thin shim” code review item: removed the blanket `globals().update`/`__getattr__` bridge from `frame_compare.py`, explicitly aliased the handful of helpers we still expose for backwards compatibility, and added a `typings/frame_compare/__init__.pyi` stub so Pyright flags any future wildcard re-exports. Updated the CLI/runner tests (`tests/test_frame_compare.py`, `tests/test_console_safety.py`, `tests/test_paths_preflight.py`, `tests/cli/test_doctor.py`—known as `tests/test_cli_doctor.py` before Phase 9.9) to import helpers from `src.frame_compare.core`/`cli_runtime` directly, keeping the shim focused on Click wiring.
- *2025-11-08:* Delivered the promised programmatic runner API knobs: `RunRequest` now accepts `reporter_factory`/`reporter`/`console`, `quiet=True` swaps in a `NullCliOutputManager` so automation logs remain silent, and README documents how to inject a custom reporter. Added regression tests ensuring quiet mode bypasses the CLI renderer and that custom factories are respected.

- *2025-11-09:* Phase 5 completion: confirmed TMDB orchestration already flows through `frame_compare.resolve_tmdb_workflow` (backed by `src.frame_compare.tmdb_workflow.resolve_workflow`), verified reporter injection docs/tests cover automation use, and reran quality gates on a connected host — `npx pyright --warnings`, `.venv/bin/ruff check`, and `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` (258 passed in 7.21 s) to bypass the auto-loaded vsengine plugin. Recorded results here and flipped the Phase 5 checklist rows to ☑.

- *2025-11-09:* Phase 1.1 prep for the modularization refactor: captured `git status -sb`, ran `pytest -q` (204 passed, 54 skipped, 4.90 s), `.venv/bin/ruff check` (pass), and `npx pyright --warnings` (0 errors). These baseline numbers log the required Phase 0 checklist before extracting the dedicated preflight module.
- *2025-11-09:* Phase 1.1 implementation: promoted the preflight helpers to a public API (`resolve_workspace_root`, `resolve_subdir`, `collect_path_diagnostics`, `prepare_preflight`, `PreflightResult`), rewired the CLI/runner/tests/typings, and updated the refactor tracker + checklist. Verification: `pytest -q` (204 passed, 54 skipped, 4.66 s), `.venv/bin/ruff check` (pass), `npx pyright --warnings` (0 issues).
- *2025-11-09:* Hardened tonemap override validation to reject NaN/Inf inputs and enforce positive `target_nits`, expanding the CLI regression tests accordingly. Verification: `.venv/bin/ruff check` (pass), `npx pyright --warnings` (blocked offline, npm ENOTFOUND registry.npmjs.org), `uv run pyright --warnings` (blocked by sandbox permissions when opening `~/.cache/uv`), and `.venv/bin/pytest -q` (253 passed, 1 skipped).
- *2025-11-10:* Phase 4.1 alignment module finalization: `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 7]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` (265 passed, 1 skipped, 40.11 s); `.venv/bin/ruff check` (All checks passed); `.venv/bin/pyright --warnings` (0 errors, 0 warnings). Documented the runner wiring change (now calling `alignment_runner.apply_audio_alignment`), removed the redundant `_maybe_apply_audio_alignment` alias, and logged the remaining VSPreview script-unit test follow-up.
- *2025-11-09:* Updated CODEX/AGENTS guardrails to prioritize `.venv/bin/pyright`/Ruff/Pytest, explicitly allow `.venv`/`.uv_cache`/`~/.cache/uv` access, and document the `uv sync --all-extras --dev` setup workflow so future runs don’t depend on npm/network access.
- *2025-11-09:* Added `MANIFEST.in` to prune dev-only folders (`tests/`, `docs/`, `Legacy/`, `refactor/`, `tools/`, `.github/`) from release artifacts so end users install only runtime code; `comparison_videos/` is still shipped so fixture media remains available.
- *2025-11-09:* Updated CODEX/AGENTS documentation to require assistants to provide a ready-to-copy Conventional Commit subject (e.g., `chore: …`) in every task summary so users with commit hooks can paste it directly.

- *2025-11-11:* Phase 9.11 strict-mode cleanup for the runner stack: exposed public aliases for tonemap validation, media discovery, cache metadata, and alignment helpers so `runner.py` no longer references underscore exports, tightened json/layout handling (explicit `Mapping[str, object]` casts, guarded preview folding, and ensured `select_frames`’ clip parameter is typed), and removed unused VSPreview overlay code while fixing the CLI reporter stub + `_patch_core_helper` so tests keep intercepting the confirmation flow. Verification: `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `.venv/bin/ruff check` → `All checks passed!`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 40.03 s`.
- *2025-11-09:* Phase 2.2 CLI shim follow-up: restored `_collect_path_diagnostics` to run with `ensure_config=False` so `frame_compare --diagnose-paths` no longer creates config files, taught `_patch_load_config` in `tests/test_paths_preflight.py` to stub `src.frame_compare.preflight.load_config`, and re-ran `.venv/bin/ruff check` (pass), `npx pyright --warnings` (still blocked offline with `npm ENOTFOUND registry.npmjs.org`), and `.venv/bin/pytest -q` (250 passed, 1 skipped) to close the Phase 4.3 quality gates.

- *2025-11-02:* Phase 4.2 verification follow-up: fixed the CLI shim imports so Pyright can see `_core` helpers, reran `npx pyright --warnings` (0 errors, 9 benign pytest warnings), restored `src/frame_compare/core.py`’s `PROJECT_ROOT` to the repo root so presets/templates resolve, and re-ran `pytest tests/cli/test_doctor.py tests/cli/test_wizard.py` (paths were `tests/test_cli_*.py` at the time) to confirm wizard auto-launch + preset flows still pass before moving to Phase 4.3.
- *2025-11-07:* Phase 4.3 QA: captured `git status -sb` before sign-off, attempted `npx pyright --warnings` (fails offline with `npm ENOTFOUND registry.npmjs.org`), and ran `.venv/bin/ruff check` plus `.venv/bin/pytest` (247 passed, 1 skipped). Recorded the blocked Pyright step, refreshed the runner checklist, and documented Phase 5 follow-ups (runner reporter injection + async TMDB parity).
- *2025-11-03:* Completed the CLI harness rollout for runner-focused tests: introduced a `_CliRunnerEnv` fixture that stubs `_prepare_preflight` and seeds temporary workspaces, added shared helpers (`_patch_core_helper`, `_patch_runner_module`, `_patch_vs_core`, `_patch_audio_alignment`) so tests patch the same symbols the runner imports, migrated `tests/test_frame_compare.py` and `tests/test_paths_preflight.py` to the new fixtures, and reran `.venv/bin/pytest tests/test_frame_compare.py tests/test_paths_preflight.py` followed by the full `.venv/bin/pytest` suite (247 passed, 1 skipped). `npx pyright --warnings` still fails offline (npm ENOTFOUND); noted for follow-up once network access is available.
- *2025-11-10:* Phase 4.1 helper extraction: created `src/frame_compare/core.py`, rewired `runner.py` to import helpers directly (removing `_IMPL_ATTRS`), re-exported the helpers via `frame_compare.py`, refreshed tests, and documented the completion in `docs/runner_refactor_checklist.md`.
- *2025-11-01:* Phase 4.2 regression parity + documentation: reviewed wizard/doctor coverage, exercised the new runner-level regression tests (slow.pics auto-upload cleanup + audio-alignment reuse), recorded the verification in `docs/runner_refactor_checklist.md`, updated README/CHANGELOG, and re-ran `npx pyright --warnings` (0 issues) to lock in the helper extraction work.
- *2025-11-09:* Phase 3.2 quality gates + handoff: ran `npx pyright --warnings` (0 issues), `.venv/bin/ruff check`, and `.venv/bin/pytest` (246 passed in 2.36 s); updated `docs/runner_refactor_checklist.md` to mark the phase complete and documented the Phase 4 kickoff task (migrating `_IMPL_ATTRS` helpers) as the sole residual risk.
- *2025-11-08:* Phase 2.3 (runner refactor) documentation + quality gates: README now includes a "Programmatic Usage" section that demonstrates `frame_compare.runner.RunRequest`, `docs/runner_refactor_checklist.md` records the Phase 2 audit plus a residual-risk log, and `CHANGELOG.md` highlights the public API guidance. `.venv/bin/ruff check` and `.venv/bin/pytest` passed (246 tests in 2.42s). `npx pyright --warnings` could not run due to offline npm access, so rerunning Pyright remains a follow-up together with the remaining CLI-helper migration.
- *2025-11-09:* Phase 3.1 checklist review complete: verified workspace state (`git status -sb`), confirmed shim + behavior coverage (see `frame_compare.py:4415-4444`, `tests/test_frame_compare.py:52-138`), reran `npx pyright --warnings` (0 issues) and `.venv/bin/pytest` (246 passed in 2.42 s), and updated `docs/runner_refactor_checklist.md` to reflect the remaining architecture/dead-code gap caused by `_IMPL_ATTRS` relying on CLI helpers.
- *2025-11-08:* Restored the runner extraction after the rollback: `src/frame_compare/runner.py` now owns the full orchestration flow, `frame_compare.run_cli` is a shim that builds a `RunRequest` and delegates, and the Click stack (doctor/wizard/preset) stays in `frame_compare.py`. Tests that poked internal helpers now import them from the runner when needed, and the new module is documented as the supported programmatic surface. **Phase 2 hand-off:** Objective → publish a stable public runner API (docs + samples) and remove lingering CLI-only helpers from tests; Follow-ups → document programmatic invocation in README, add integration tests that call `runner.run` directly, explore packaging a `frame_compare.runner` console entry for automation; Risks → callers may rely on internal helpers before the API stabilises, so changes must remain backwards-compatible until the contract is formalised.
- *2025-11-07:* Split the CLI orchestration into `src/frame_compare/runner.py`, moving `RunResult` plus the full `run` logic behind a `RunRequest` struct. `frame_compare.py` now acts as a thin Click wrapper delegating to the runner while re-exporting compatibility symbols, keeping wizard/doctor wiring untouched.
- *2025-11-07:* Retuned tone-mapping presets to use the new libplacebo controls: upgraded `reference`/`filmic`/`spline`/`contrast`, added `bright_lift` and `highlight_guard`, nudged defaults (smoothing 45f, percentile `99.995`, contrast `0.30`), and propagated the changes through docs, config templates, and layout summaries.
- *2025-11-06:* Exposed libplacebo smoothing/scene thresholds, percentile, contrast recovery, metadata selection, Dolby Vision toggles, and tonemap debugging flags (`visualize_lut`, `show_clipping`). Config schema, CLI, layout, and docs were updated so operators can replicate libplacebo’s `high_quality` profile or audit tone-mapping output without editing scripts; compatibility shims still cover older plugins.
- *2025-11-06:* Added BT.2390 knee/DPD controls and the limited-range post-tonemap gamma stage. Config schema now exposes `knee_offset`, `dst_min_nits=0.18` defaults, `dpd_preset`, `dpd_black_cutoff`, and optional gamma lift toggles, alongside CLI overrides (`--tm-*`) and updated presets/docs/tests to prevent near-black crush regressions.
- *2025-11-06:* Added `[screenshots].export_range` (default `"full"`) to control final PNG range, expanding limited SDR to sRGB by default while retaining a `"limited"` escape hatch; updated screenshot writers, config templates, docs, and tests to reflect the change.
- *2025-11-05:* Sampled tonemapped RGB clips to detect actual colour range, aligning `_ColorRange` metadata with pixel values, preserving props across overlays, and documenting/testing the harmonised path to prevent washed-out PNGs.
- *2025-11-10:* Clarified Sequential Thinking guidance in CODEX/AGENTS/README so every stage (Scoping → Research & Spike → Implementation → Testing → Review) is logged, and `next_thought_needed` stays `true` until the final Review thought keeps the orchestrator loop active.
- *2025-10-31:* Enhanced the offline HTML report viewer with filmstrip thumbnails, selection-category filters, new difference/blink modes, and a fullscreen toggle. Updated styles, keyboard shortcuts, and documentation to reflect the richer theatre experience while keeping persistence compatible with previous localStorage payloads.
- *2025-10-30:* Auto-launched the wizard when `config/config.toml` is missing in interactive sessions, added `--no-wizard`/`FRAME_COMPARE_NO_WIZARD` opt-outs, reused the existing wizard prompt stack for config creation, and left non-interactive runs seeding the template with a reminder about `frame-compare wizard`.
- *2025-10-30:* Revamped the offline HTML report viewer with persistent zoom/fit presets, mouse-wheel zoom around the pointer, pan gestures, alignment presets, and shortcut guidance to align the offline experience with slow.pics.
- *2025-10-30:* Audio alignment progress now uses a Rich spinner instead of a misleading 0/1 progress bar to keep CLI feedback honest during offset estimation.
- *2025-10-22:* Default slow.pics uploads now ship disabled (`auto_upload=false`) with a CLI warning when operators opt in, documentation tables are generated from dataclass defaults, Ruff linting was added to CI (Pyright made blocking), a `frame-compare` console script was registered, and the unused `tools/readability_check.py` helper was retired.
- *2025-10-23:* Introduced the offline HTML report (configurable via `[report]` or `--html-report`) backed by `src/report.py`, vendored assets (`src/data/report/`), and CLI integration that auto-opens the generated `index.html` when requested. Added unit coverage (`tests/test_report.py`) and documented the workflow in README/config references.
- *2025-10-24:* Enhanced the HTML report viewer with a mode toggle (`slider` vs `overlay`), added keyboard/click encode cycling, embedded report data to avoid `file://` fetch issues, and expanded JS/CSS to support both viewing experiences.
- *2025-10-20:* Guaranteed VSPreview script uniqueness by adding per-run UUID suffixes and logging when a timestamped name is already present so operators keep manual edits across concurrent sessions.
- *2025-10-20:* Documented the SDR odd-geometry pivot (config guide plus dedicated geometry notes), surfaced Rich console notifications for full-chroma promotions, and clarified that dithering only occurs during the final 16→8 RGB conversion while HDR behaviour remains unchanged.
- *2025-10-20:* Audited the new `zip(..., strict=True)` guards in geometry planning/rendering: confirmed they surface invariant breaks earlier (helpful for mismatched clip/plan lists or stale colour metadata), noted the trade-off that they now raise `ValueError` instead of silently truncating when callers mis-size inputs, and captured mitigation strategies (defensive asserts in planner tests and explicit list construction) so operational runs fail fast with actionable logs rather than partial renders.
- *2025-10-18:* When screenshot rendering receives VapourSynth clips without matrix/transfer metadata we now probe frame props and default to Rec.709 limited values so `resize.Point` can emit RGB24 without raising "no path between colours"; regression tests cover the fallback and metadata-preservation paths.
- *2025-10-17:* Finalised the VSPreview-assisted manual alignment UX, documenting the new flag in README/REFERENCE, expanding the audio-alignment guide with prerequisites and fallback behaviour, surfacing the hook in CLI help, and extending automated + manual QA coverage for the headless fallback path.
- *2025-10-16:* Enforced workspace containment for analysis cache and audio offset files via `_resolve_workspace_subdir`, added regression coverage for escape attempts, removed the generated `config.toml` (template remains the source of defaults), and limited automatic screenshot cleanup to directories created during the active run.
- *2025-10-16:* Constrained supported Python versions to 3.13.x (`>=3.13,<3.14`) because `librosa`/`numba` fail to build on 3.14; updated pyproject/lock files accordingly.
- *2025-10-14:* Locked workspace root discovery to `--root`/`FRAME_COMPARE_ROOT`/sentinel hierarchy, seeded config under `ROOT/config/config.toml`, enforced `ROOT/comparison_videos[/screens]` outputs, and added diagnostics + site-packages guardrails.
- *2025-10-12:* Default config seeding now targets `~/.frame-compare/config.toml`, the packaged template lives under `src/data/` with explicit package data so wheels retain it, and `[paths].input_dir` defaults to `~/comparison_videos` to avoid site-packages permission traps. *(superseded by 2025-10-14 workspace root lock.)*
- *2025-10-11:* `copy_default_config` now honours `$FRAME_COMPARE_TEMPLATE_PATH` and falls back to the repository template when the packaged `data` module is unavailable, letting us drop the setuptools package-dir mapping without breaking config seeding.
- *2025-10-11:* Screenshot generation wraps directory creation failures in `ScreenshotError` so permission-denied errors surface with actionable guidance about choosing a writable `[paths].input_dir`.
- *2025-10-09:* When the packaged install directory is read-only we now seed the default config under `~/.frame-compare/config.toml`, logging the relocation so users know to point overrides there instead of the site-packages path. *(legacy approach before 2025-10-14 root lock.)*
- *2025-10-10:* Restored the ability to disable FFmpeg screenshot timeouts by permitting `screenshots.ffmpeg_timeout_seconds = 0` and treating non-positive values as "no timeout" when invoking FFmpeg.
- *2025-10-18:* Added `screenshots.ffmpeg_timeout_seconds` plus `-nostdin` when spawning FFmpeg to stop runaway renders from freezing Windows shells; surfaced the timeout in CLI render metadata and config docs.
- *2025-10-17:* CLI layout tweaks: dropped the banner headline, repurposed the Analyze slot to show cached-metric reuse, removed the At-a-Glance crop-mod snippet in favour of resolved tonemap nits, and slimmed the Summary output block to avoid redundant frame counts.
- *2025-10-16:* Deep review flagged that `screenshots.directory_name` must be constrained to stay under the resolved input root before cleanup; follow-up will enforce containment checks before writing or deleting screenshot outputs (see `docs/deep_review.md`).
- *2025-10-15:* Relocated bundled comparison fixtures from `tests/fixtures/media/comparison_videos` to the repository-root
  `comparison_videos/` directory so CLI defaults, config templates, and contributor docs reference the same location as the
  fallback resolution added to `run_cli`.
- *2025-10-14:* Adjusted CLI theming to separate hierarchy (muted section badges, yellow subheads) and rewrote the At-a-Glance summary to surface sampling, window, and alignment metrics requested in the usability review.
- *2025-10-13:* Dropped the unused `types-pytest` dependency from the dev group because the package is unavailable on PyPI and broke `uv run` environment creation on fresh clones. CI keeps installing real `pytest` through the dev group, so workflows and local test runs continue to function normally.
- *2025-10-12:* Introduced local stubs for click, requests, httpx, and rich plus tighter JSON-tail helpers in tests to eliminate Pyright/Pylance import and indexing errors while keeping diagnostics strict.
- *2025-10-11:* Audited the `docs/` catalog, refreshed the deep-review memo with current safeguards/follow-ups, and corrected README reference defaults to match the live config schema.
- *2025-10-10:* Hardened CLI progress configuration by validating styles during config load, normalizing the stored value, and simplifying runtime flag handling to avoid getattr/except patterns flagged by linters.
- *2025-10-09:* Adjusted overlay text defaults so minimal mode now shows resolution/upscale context and frame-selection type while diagnostic mode drops per-frame selection detail lines that were redundant on-screen but remain available in cached metadata.
- *2025-10-02:* Restricted audio alignment's NumPy warning suppression to local contexts, paired with regression coverage that preserves global diagnostics while muting noisy dependencies.
- *2025-10-02:* Bounded the TMDB response cache to a configurable entry limit with TTL-aware eviction to stop unbounded growth flagged in deep-review performance findings.
- *2025-10-01:* Documented the audio alignment pipeline in `docs/audio_alignment_pipeline.md` to centralize requirements, workflow, and offsets file semantics for ongoing feature work.
- *2025-10-01:* Persisted selection metadata sidecar v1 with deterministic cache keys, JSON-tail exposure, and generated.compframes annotations to satisfy the CLI selection cache persistence guide.
- *2025-09-30:* Standardised group subhead styling across CLI sections: accent-subhead prefixes (`›`/`>` fallback), dim divider rules sized to block content, column alignment for numeric values, and verbose legends describing token roles to satisfy `features/CLI/GUIDE.md`.
- *2025-09-30:* Simplified diagnostic overlays by replacing the HDR MAX/AVG measurement block with render resolution, mastering display luminance (for HDR sources), and cached frame-selection metadata while trimming redundant frame-info lines to keep CLI banners uncluttered.
- *2025-09-19:* Adopted CLI layout styling DSL with semantic spans and data-driven highlight rules. Renderer now consumes palette roles (`value`, `unit`, `path`, etc.), honors section accent theming, and evaluates JSON-configured thresholds (e.g., tonemap verification, boolean states) to keep formatting declarative.
- *2025-10-14:* Adopted key/value styling in the CLI Summary list to mirror At-a-Glance key/value formatting and keep closing metrics aligned.
- *2025-11-10:* Restored runner's audio-alignment hook to `core._maybe_apply_audio_alignment` so tests and downstream callers can continue stubbing the helper, then deep-copied the JSON tail's audio block before deriving the CLI layout view to keep manual trims/offsets isolated from UI mutations. (Superseded later the same day by the “Phase 4.1 alignment module finalization” entry once planner/runner tests were updated to stub the new module boundary.) Reference: Python 3.11 FAQ on `dict.copy()` shallow semantics ([source](https://github.com/python/cpython/blob/v3.11.14/Doc/faq/programming.rst) @2025-11-10).
- *2025-11-10:* Locked pytest configuration to skip the third-party `vsengine` plugin (which otherwise instantiates an abstract `VapoursynthEnvironment` during collection) by adding `addopts = "-p no:vsengine"` under `[tool.pytest.ini_options]` in `pyproject.toml`. This makes plain `pytest`/VS Code discovery behave the same as our documented `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 …` command and unblocks commit hooks that run `pytest` without environment overrides.
- *2025-11-12:* CI maintenance — updated `.github/workflows/ci.yml` so the Linux test job installs the `preview` extra (ensuring VSPreview/PySide6 exist for `tests/runner/test_audio_alignment_cli.py::test_launch_vspreview_generates_script`) and switched the lint job’s import-linter install step to `uv pip install import-linter` to avoid the missing `pip` module inside `.venv`. No local tests rerun (workflow-only change).
- *2025-11-13:* Deprecated `[screenshots].center_pad` so padding is always centered, expanded README/README_REFERENCE/config_audit docs with the Slow.pics key list, screenshot semantics paragraph, JSON-tail snippet, CLI stability note, and config audit footnote (plus a matching template comment) while keeping `docs/_generated/config_tables.md` as the authoritative schema; `src/config_loader.py` now warns/coerces false values, geometry call sites force `True`, and `tests/screenshots/test_center_pad_deprecated.py` asserts the warning.
  - `date -u +%Y-%m-%d` → `2025-11-13`
  - `UV_CACHE_DIR=.uv_cache PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 uv run --no-sync python -m pytest -q` → `307 passed, 1 skipped in 28.38s`
  - `UV_CACHE_DIR=.uv_cache uv run --no-sync npx pyright --warnings` → fails: `npm` cannot reach `https://registry.npmjs.org/pyright` (getaddrinfo `ENOTFOUND` in the offline sandbox).
  - `UV_CACHE_DIR=.uv_cache uv run --no-sync ruff check` → `All checks passed!`
  - `UV_CACHE_DIR=.uv_cache uv run --no-sync lint-imports --config importlinter.ini` → `Contracts: 3 kept, 0 broken.`
  - Source anchors used: `src/screenshot.py` lines 1369–1460; `src/frame_compare/slowpics.py` adapter/timeouts; `src/datatypes.py`: `ScreenshotConfig` and `SlowpicsConfig`.
- *2025-11-13:* MCP stack update — Replace Serena with Codanna for discovery/context and pair Codanna with Sequential‑Thinking (ST) for structured thoughts while keeping the authoritative plan in Codex `update_plan`. Updated `CODEX.md` and `agents.md` to:
  - remove Serena references and planning-mode mentions,
  - add Codanna MCP server config and quickstart,
  - document token‑efficient defaults (JSON, limit 3–5, threshold 0.6–0.7, `lang`), and
  - add a concise “Codanna + ST” workflow (Discovery → Plan → Thoughts → Validate/Commit).
  Historical references to Serena remain in CHANGELOG/DECISIONS for provenance; guidance docs no longer prescribe Serena. No external sources used.
- *2025-11-13:* refactor(cache): metrics payloads now bundle clip identity snapshots (paths, sizes, mtimes, opt-in sha1) and the selection sidecar reads the same snapshot.
  - Problem: caches could be reused across directories when filenames matched because only relative names were stored, and the selection sidecar re-probed the filesystem which reintroduced race conditions.
  - Decision: introduce a frozen `ClipIdentity` dataclass populated by `_build_cache_info`, persist those records under a v2 cache payload with `inputs.clips`, gate sha1 generation behind the `FRAME_COMPARE_CACHE_HASH` env flag, and have the selection sidecar builder/loader reuse the precomputed snapshot instead of restatting.
  - Impact: first runs invalidate v1 payloads (one-time recompute) but future runs avoid cross-folder reuse by comparing absolute paths plus size/mtime (and sha1 when opted in); selection reloads now avoid filesystem churn so frame picks align with cached metrics.
  - Verification:
    - `date -u +%Y-%m-%d` → `2025-11-13`
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/test_cache_identity.py` →
      ```
      ....                                                                     [100%]
      4 passed in 0.01s
      ```
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/test_analysis.py::test_select_frames_uses_cache` →
      ```
      .                                                                        [100%]
      1 passed in 0.01s
      ```
    - `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`
- *2025-11-15:* Relaxed HDR source detection and metadata backfill to stop clips with partial HDR props (e.g., only `_Transfer=16` or MDL/CLL stats) from being treated as SDR. `_props_signal_hdr` now treats any HDR primaries/transfer flag or mastering metadata as a usable signal, and `normalise_color_metadata` injects BT.2020/ST2084 defaults (preferring `ColorConfig.default_*_hd` when set) before calling `_apply_frame_props_dict` so libplacebo always receives primaries/matrix hints documented in VapourSynth’s `ModifyFrame` property API ([source](https://github.com/vapoursynth/vapoursynth/blob/master/doc/functions/video/modifyframe.rst@2025-11-15T04:07:19Z)). This keeps tonemapping engaged even when containers omit `_Primaries`.
  - `date -u +%Y-%m-%d` → `2025-11-15`
  - `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`
  - `.venv/bin/ruff check` → `All checks passed!`
  - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/test_vs_core.py tests/test_screenshot.py` →
    ```
    ........................................................................ [ 92%]
    ......                                                                   [100%]
    78 passed in 0.10s
    ```
- *2025-11-15:* Blank-prefix padding now preserves all HDR hints (matrix/primaries/transfer/color-range plus any MasteringDisplay*/ContentLightLevel* props) when `init_clip` prepends negative trims, ensuring `_props_signal_hdr` still sees the mastering metadata once tonemapping runs. `_collect_blank_extension_props` now filters frame props with `_is_hdr_prop`, consistent with VapourSynth’s documented ability to copy frame properties via `std.SetFrameProp`/`ModifyFrame` ([source](https://github.com/vapoursynth/vapoursynth/blob/master/doc/functions/video/modifyframe.rst@2025-11-15T04:07:19Z)).
  - `date -u +%Y-%m-%d` → `2025-11-15`
  - `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`
  - `.venv/bin/ruff check` → `All checks passed!`
  - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/test_vs_core.py tests/test_screenshot.py` →
    ```
    ........................................................................ [ 90%]
    ........                                                                 [100%]
    80 passed in 0.11s
    ```
- *2025-11-15:* Persisted HDR frame props at source load and rehydrated them before tonemapping so padding/trimmed clips keep their original mastering metadata.
  - Problem: `_snapshot_frame_props` was only consulted after trims/padding, so negative trims and blank extensions erased `_Matrix`/`_Transfer`/`MasteringDisplay*` hints and SDR overlays appeared even when true HDR metadata existed.
  - Decision: `vs.source.init_clip` now snapshots props immediately after `_open_clip_with_sources` and stores them on `ClipPlan.source_frame_props`, `generate_screenshots` passes those dictionaries through to `process_clip_for_screenshot`, and `_apply_frame_props_dict` merges the stored props with current ones before colour normalisation so runtime overrides still win. This relies on VapourSynth’s documented ability to stamp metadata via `std.SetFrameProp` ([source](https://github.com/vapoursynth/vapoursynth/blob/master/doc/functions/video/setframeprop.rst@2025-11-15T00:25:00Z)).
  - Impact: Screenshot overlays (notably diagnostic HDR lines) now show true mastering luminance even when plans pad negative trims, and TonemapInfo correctly marks HDR clips when only MasteringDisplay hints were present. Added regression tests in `tests/test_vs_core.py` and `tests/test_screenshot.py` to cover both the tonemap and screenshot paths.
  - Verification:
    - `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`
    - `.venv/bin/ruff check` → `All checks passed!`
    - `.venv/bin/pytest -q tests/test_vs_core.py tests/test_screenshot.py` →
      ```
      ........................................................................ [ 87%]
      ..........                                                               [100%]
      82 passed in 0.17s
      ```
- *2025-11-18:* feat(runner DI): Introduced `RunDependencies`, `default_run_dependencies`, and `RunContext` so `runner.run` sequences services through explicit, testable layers (source:docs/refactor/runner_service_split.md@Track B).
  - Problem: Runner instantiated services internally, so CLI shims/tests couldn’t inject doubles and state flowed through ad-hoc locals instead of a typed context.
  - Decision: Added `RunDependencies`/`default_run_dependencies` to `src/frame_compare/runner.py`, updated `frame_compare.run_cli` to pass the bundle, and wrapped metadata/alignment data in `RunContext`. Added `tests/runner/test_runner_services.py` to assert service order, CLIAppError propagation, and reporter flag wiring; existing CLI/Dolby stubs now accept the `dependencies` kwarg.
  - Verification:
    - `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`
    - `.venv/bin/ruff check` → `All checks passed!`
    - `.venv/bin/pytest -q` → `421 passed, 1 skipped`
- *2025-11-19:* chore(runner DI): Let `runner.run` construct default dependencies after preflight so service factories can see the real `cfg`, reporter, and cache paths (source:docs/refactor/runner_service_split.md@Track B B3).
  - Problem: `frame_compare.run_cli` instantiated `default_run_dependencies()` before preflight, so MetadataResolver/AlignmentWorkflow never saw runtime context (feature flags, cache roots) even though `default_run_dependencies(cfg=..., reporter=..., cache_dir=...)` already accepted those parameters. Direct `runner.run` callers benefited from richer factories while the main CLI path did not.
  - Decision: Removed the eager factory call from `frame_compare.run_cli`, letting `runner.run` invoke `default_run_dependencies` after it resolves configuration and reporter wiring. Updated `tests/test_frame_compare.py::test_run_cli_delegates_to_runner` to assert the shim now passes `dependencies=None`, recorded Track B review notes, and confirmed DI override hooks still work in `tests/runner/test_runner_services.py`.
  - Verification:
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/test_frame_compare.py::test_run_cli_delegates_to_runner`
- *2025-11-17:* feat(cli cache pipeline): cached runs now emit a canonical `.frame_compare.run.json` snapshot plus a unified renderer so live and cached output share identical sections and semantics.
  - Problem: Cached reruns reprinted partial sections, summary banners skipped entirely when the pipeline short-circuited, and there was no way to rehydrate CLI output without rerunning the full analysis.
  - Decision: Introduced `result_snapshot.RunResultSnapshot` (JSON-safe layout/flag/section metadata), persisted it beside screenshots, and taught the runner to render sections exclusively through `render_run_result`. Added CLI flags: `--from-cache-only` (hydrate snapshot and exit), `--no-cache` (skip cache probes/force recompute with metadata), and `--show-partial` (surface cache-derived partial sections). Snapshot metadata includes availability markers so future cache reconstructions can hide sections cleanly.
  - Verification:
    - `Get-Date -AsUTC -Format 'yyyy-MM-dd'` → `2025-11-17`
    - `.venv\Scripts\pyright --warnings` → `0 errors, 0 warnings, 0 informations`
    - `.venv\Scripts\ruff check` → `All checks passed!`
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv\Scripts\pytest -q` → `361 passed in 21.73s`
- *2025-11-16:* chore(ci): align release-please scope with commitlint policy.
  - Problem: release PR merges were titled `chore(main): release …` because release-please injects `${scope}` from the target branch name in its default pattern, and `main` is not in our allowed `scope-enum`, so commitlint failed on every release branch check.
  - Decision: Set `pull-request-title-pattern` to `chore(ci): release${component} ${version}` in `.github/release-please-config.json`, forcing a `ci` scope that’s already permitted while keeping the rest of the template intact per the customization guidance (source:https://github.com/googleapis/release-please/blob/main/docs/customizing.md@2025-11-16T03:28:42Z).
  - Verification: N/A (configuration-only change).
- *2025-11-16:* chore(devx): make Husky `npm test` cross-platform and document the pytest plugin toggle.
  - Problem: Windows Husky runs failed because `npm test` set `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1` using POSIX syntax, and there was no documented way to skip that flag on machines that rely on local pytest plugins while still enforcing it on macOS/Linux.
  - Decision: Added `cross-env` (per usage guidance, source:https://github.com/kentcdodds/cross-env/blob/main/README.md@2025-11-16T17:12:54Z) and routed the `test` script through `tools/run_pytest.mjs`, which locates the per-venv pytest executable, forces `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1` by default, and lets developers opt out by exporting `FC_SKIP_PYTEST_DISABLE=1`. Updated `agents.md`/`CODEX.md` so both Codex and advisors know how to flip the override on Windows.
    - Verification: `npm test`
- *2025-11-17:* fix(snapshot): reject corrupt cache payloads and persist per-section availability so cached renders hide incomplete blocks by default.
  - Problem: `RunResultSnapshot.from_json_dict()` trusted whatever JSON types landed in `created_at`, `sections`, or `json_tail`, so malformed cache files could crash cache-only runs. The runner also hard-coded every CLI section to `FULL`, so publishing/render sections still surfaced even when slow.pics uploads were disabled or screenshots never materialised.
  - Decision: Added `SnapshotDecodeError` guards plus list coercion helpers to validate ISO timestamps and mapping types (per CPython's `datetime.fromisoformat` requirements, [source](https://github.com/python/cpython/blob/v3.11.14/Doc/library/datetime.rst) @ 2025-11-17T16:50:00Z) and taught `load_snapshot()` to treat bad payloads as cache misses. Runner builds a `SectionState` map (default `MISSING`), marks success cases `FULL`, and downgrades `[RENDER]`/`[PUBLISH]` to `PARTIAL`/`MISSING` when screenshots are absent or slow.pics uploads are disabled-these notes propagate into snapshots so `--show-partial`/`--show-missing` actually control cached output. Added regression tests for corrupt cache files and snapshot-driven render toggles, and documented the new semantics in README/CHANGELOG.
  - Verification:
    - `.venv\Scripts\pyright --warnings`
    - `.venv\Scripts\ruff check`
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv\Scripts\pytest -q tests/runner/test_cli_entry.py tests/result_snapshot`
- *2025-11-18:* feat(cli cache UX): expose `--show-missing/--hide-missing`, propagate `show_missing_sections` through the public API, and broaden section availability so cached runs only render viewer/report/audio/VSPreview blocks when data exists.
  - Problem: The CLI always printed "(not available from cache…)" banners for sections marked `MISSING`, so operators couldn't suppress them when reviewing cache-only runs. Section availability metadata only covered `[RENDER]`/`[PUBLISH]`, so cached output spuriously rendered audio alignment, VSPreview, and viewer/report blocks even when HTML reports, offsets, or dependencies were absent.
  - Decision: Added `show_missing_sections` to `RenderOptions`, `RunRequest`, `run_cli`, stubs, and the Click entry point, wiring paired `--show-missing/--hide-missing` flags (default on) through the CLI. Introduced `_apply_section_availability_overrides()` so the runner now marks viewer/report, audio alignment, VSPreview, and slow.pics sections as `MISSING`/`PARTIAL` based on cached metadata, then updated README/CHANGELOG/docs to explain the new flag and cache heuristics. Added regression tests for the renderer, CLI flag plumbing, and the availability helper.
  - Verification:
    - `Get-Date -AsUTC -Format 'yyyy-MM-dd'`  `2025-11-18`
    - `.venv\Scripts\pyright --warnings`  `0 errors, 0 warnings, 0 informations`
    - `.venv\Scripts\ruff check`  `All checks passed!`
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv\Scripts\pytest -q tests/result_snapshot tests/runner/test_cli_entry.py tests/runner/test_section_availability.py` 
      ```
      ........................................                                 [100%]
      40 passed in 0.51s
      ```
- *2025-11-18:* docs(flag audit): converted the repeating Notes/Findings templates in `docs/refactor/flag_audit.md` from blockquoted headings into ATX `####` headings with per-track prefixes (e.g., "A3 Findings", "B4 Findings") to satisfy MD003/MD024 and retain the template prompts.
  - Decision: Promote each Notes/Findings/Follow-ups/Reviewer/Date label beneath A2/A3/B3/B4 to real ATX headings and keep their placeholder bullet lists so contributors can still fill in per-track data without duplicate heading IDs.
  - Impact: Markdownlint navigation panes no longer collide on duplicate headings, and the audit template renders consistently in docs sites.
  - `Get-Date -AsUTC -Format 'yyyy-MM-dd'`  `2025-11-18`
  - Verification: N/A (documentation-only change).
- *2025-11-19:* chore(track-c): finalize publishing documentation, config flag docs, and runner observability.
  - Problem: Track C’s checklist still showed unchecked tasks with no Implementation/Review notes, operators couldn’t discover the `runner.enable_service_mode` flag outside the CLI, and `run()` never logged whether the publisher services or the legacy path executed, making flag validation difficult.
  - Decision: Filled in Track C planning/implementation/review sections (docs/refactor/runner_service_split.md) with concrete scope, dates, and verification evidence; documented `[runner].enable_service_mode` inside `src/data/config.toml.template` plus README’s CLI/config table; and taught `src/frame_compare/runner.py` to mark a `service_mode_enabled` reporter flag while logging/printing the active publishing mode for each run.
  - Verification: Leveraged the existing Track C command set (pyright/ruff/pytest recorded earlier on 2025-11-19); no code paths outside logging/docs changed and no additional execution was required.
- *2025-11-19:* feat(diagnostics): extend overlay JSON with DV/HDR/range metadata and gated per-frame metrics.
  - Problem: the diagnostic overlay roadmap (Track C) left `json_tail["overlay"]["diagnostics"]` empty beyond simple overlays, CLI flag coverage for per-frame metrics was missing, and tests/docs didn’t describe the new data contract.
  - Decision: centralized the diagnostics helpers (DoVi/HDR/range/frame metrics) to avoid circular imports, taught the runner to always populate the diagnostics block (including gating metadata and per-clip HDR/dynamic-range summaries), added the `[diagnostics].per_frame_nits` config with CLI overrides, and refreshed README + flag audit guidance. New suites cover runner JSON output, CLI flag propagation, overlay text rendering, and the helper module itself.
  - Verification:
    - `.venv/bin/pyright --warnings`
    - `.venv/bin/ruff check`
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/runner/test_overlay_diagnostics.py tests/runner/test_cli_entry.py tests/runner/test_dovi_flags.py tests/render/test_overlay_text.py tests/frame_compare/test_diagnostics.py`
- *2025-11-20:* feat(overlay diagnostics): surface per-frame measurement and DV RPU L1 stats plus metadata flags.
  - Problem: diagnostic overlays only echoed clip-level HDR/DoVi targets and config intent; per-frame brightness reused a single “Frame Nits” label and DV metadata presence (including Level 1 stats) was opaque to downstream consumers.
  - Decision: reformatted per-frame metrics as `Measurement MAX/AVG`, added a DV RPU Level 1 MAX/AVG line when L1 data is in frame props, and marked DoVi overlays lacking metadata with a clarifying suffix. Runner diagnostics now publish `metadata_present` and `has_l1_stats` flags alongside the DV summary. Updated tests/docs to match the new overlay text.
  - Verification:
    - `.venv/bin/pyright --warnings`
    - `.venv/bin/ruff check`
    - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/frame_compare/test_diagnostics.py tests/render/test_overlay_text.py tests/runner/test_overlay_diagnostics.py tests/runner/test_dovi_flags.py tests/test_screenshot.py`
- *2025-11-20:* fix(vspreview suggestions): keep VSPreview overlay hints intact when a frame bias is configured.
  - Problem: `frame_offset_bias` nudged measured offsets toward zero even in VSPreview suggestion mode, so 1‑frame hints collapsed to `0f / 0.000s` and the overlay offered no guidance.
  - Decision: Skip applying the frame bias while preparing VSPreview suggestions and add regression coverage to lock the behaviour.
  - Verification: `.venv/bin/pytest tests/runner/test_audio_alignment_cli.py::test_vspreview_suggestions_ignore_frame_bias`
- *2025-11-20:* chore(audio-alignment): remove `frame_offset_bias` and `confirm_with_screenshots` config flags as obsolete.
  - Problem: The bias flag still risked collapsing small VSPreview hints, and screenshot confirmation adds interactive friction with no remaining consumers.
  - Decision: Dropped both fields from the config schema/template/docs, simplified confirmation to auto-approve without screenshot prompts, removed bias application in the alignment runner, and updated tests to reflect the streamlined flow.
  - Verification: `.venv/bin/pyright --warnings`; `.venv/bin/ruff check`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q`
- *2025-12-10:* fix(cli layout): restored CLI output fidelity after refactor.
  - Problem: CLI runs exited early with a `NameError` (`report_override` typo in `frame_compare.run_cli`) and rendered layout text showed literal `[[...]]` markers (style span parser looked for `]]]` instead of the actual `]]` delimiters), breaking runner CLI output tests.
  - Decision: Corrected `run_cli` to pass `report_enable_override` through to `RunRequest` and fixed `_apply_style_spans` in `src/frame_compare/layout/renderer.py` to consume `[[role]]...[[/]]` spans using the proper `]]` closing token so Rich markup is applied (and stripped when `--no-color`).
  - Verification: `.venv/bin/pytest -q tests/runner/test_cli_entry.py::test_cli_applies_overrides_and_naming`; `.venv/bin/pytest -q tests/runner/test_audio_alignment_cli.py::test_audio_alignment_block_and_json`; `.venv/bin/pytest -q tests/cli/test_layout.py`
- *2025-12-11:* fix(vspreview/reporting): keep VSPreview hints and report metadata consistent.
  - Problem: Top-level vs audio_alignment VSPreview metadata could diverge (mode/hints), layout expression eval rejected boolean/None literals, and slow.pics report failures left `report_block` enabled with `path="None"`. VSPreview manual offsets display also duplicated trim lines.
  - Decision: Mirror VSPreview mode and hint values into the audio alignment block, seed `use_vspreview` and nested `vspreview_mode` from config, permit `True`/`False`/`None` in layout eval namespace, disable report metadata when slow.pics generation fails, and remove redundant VSPreview display wiring.
  - Verification: `.venv/bin/pyright --warnings`; `.venv/bin/ruff check`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q`
